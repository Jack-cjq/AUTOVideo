import{_ as Ve,u as he,r as n,a as W,n as be,c as C,b as g,e as s,w as t,f as k,k as E,d as o,i as X,F as H,t as P,h as m,y as M,j as Y,R as ke,S as xe,E as i}from"./index-Cc1A4YXN.js";const Re={class:"profile-page"},qe={class:"profile-info-item"},Ie={class:"info-content"},Ne={class:"current-value"},Fe={class:"form-actions"},Ue={class:"profile-info-item"},$e={class:"info-content"},Oe={class:"current-value"},Se={key:0},Be={class:"current-email-container"},ze={class:"current-email"},Me={class:"email-input-container"},Ae={class:"form-actions"},Ze={key:1},Le={class:"email-input-container"},Te={class:"form-actions"},je={key:2},De={class:"verification-summary"},Ge={class:"summary-item"},He={class:"summary-value"},Je={class:"summary-item"},Ke={class:"summary-value"},Qe={class:"form-actions"},We={class:"profile-info-item"},Xe={class:"info-content"},Ye={class:"old-password-container"},ea={key:0,class:"password-error-message"},aa={key:1,class:"password-success-message"},la={class:"form-actions"},sa={__name:"Profile",setup(ra){const _=he(),U=n(null),u=n(null),$=n(null),A=n(!1),Z=n(!1),J=n(!1),x=n(!1),R=n(!1),q=n(0),O=n(0),c=n(!1),f=n(""),S=n("");n(!1);const I=n(!1),L=n(""),N=n(""),T=n(!1),j=n(!1),V=n(!1),D=n(!1),h=n(!1),F=n(!1),B=n(!1),z=n(!1),G=n(!1),y=W({username:""}),a=W({email:"",oldEmailCode:"",newEmailCode:""}),d=W({oldPassword:"",newPassword:"",confirmPassword:""}),se={username:[{required:!0,message:"用户名不能为空",trigger:"blur"},{min:2,max:16,message:"用户名长度必须在2-16个字符之间",trigger:"blur"},{pattern:/^[\u4e00-\u9fa5a-zA-Z0-9]+$/,message:"用户名只能包含中英文和数字",trigger:"blur"},{validator:async(r,e,l)=>{if(!e){l();return}if(e===S.value){l();return}try{(await E.auth.checkUsernameExists(e)).data.exists?l(new Error("用户名已被使用")):l()}catch(p){console.error("检查用户名失败:",p),l()}},trigger:"blur"}]},re={email:[{required:!0,message:"邮箱不能为空",trigger:"blur"},{type:"email",message:"邮箱格式不正确",trigger:"blur"},{validator:async(r,e,l)=>{if(!e||e===f.value){l();return}try{(await E.auth.checkEmailExists(e)).data.exists?l(new Error("邮箱已被使用")):l()}catch(p){console.error("检查邮箱失败:",p),l()}},trigger:"blur"}],oldEmailCode:[{required:()=>a.email!==f.value,message:"原邮箱验证码不能为空",trigger:"manual"},{min:6,max:6,message:"验证码为6位数字",trigger:"manual"}],newEmailCode:[{required:()=>a.email!==f.value&&c.value,message:"新邮箱验证码不能为空",trigger:"blur"},{min:6,max:6,message:"验证码为6位数字",trigger:"blur"}]},w={oldPassword:[{required:!1,message:"旧密码不能为空",trigger:"manual"}],newPassword:[{required:!1,message:"新密码不能为空",trigger:"manual"},{min:8,max:20,message:"密码长度必须在8-20个字符之间",trigger:"manual"},{pattern:/^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,20}$/,message:"密码必须包含字母和数字，支持特殊字符",trigger:"manual"},{validator:(r,e,l)=>{e===d.oldPassword?l(new Error("新密码不能与原密码相同")):l()},trigger:"manual"}],confirmPassword:[{required:!1,message:"确认密码不能为空",trigger:"manual"},{validator:(r,e,l)=>{e!==d.newPassword?l(new Error("两次密码输入不一致")):l()},trigger:"manual"}]},oe=async()=>{try{const r=await E.auth.getProfile();r.code===200&&r.data&&(y.username=r.data.username||"",S.value=r.data.username||"",a.email=r.data.email||"",f.value=r.data.email||"",_.username=y.username,_.email=r.data.email||"")}catch(r){console.error("Load profile failed:",r)}},ie=()=>{const e=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.email)&&a.email!==f.value;F.value=e&&c.value,e?(a.newEmailCode="",V.value=!1,h.value=!1,u.value&&u.value.clearValidate(["newEmailCode"])):(F.value=!1,h.value=!1)},te=()=>{D.value=a.oldEmailCode&&a.oldEmailCode.length===6},ne=()=>{h.value=a.newEmailCode&&a.newEmailCode.length===6;const e=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.email)&&a.email!==f.value;h.value=h.value&&e},de=async()=>{if(a.oldEmailCode){T.value=!0;try{(await E.auth.verifyOldEmailCode({code:a.oldEmailCode})).code===200?(c.value=!0,N.value="",D.value=!1,i.success("原邮箱验证成功"),u.value&&u.value.clearValidate(["oldEmailCode"])):(c.value=!1,N.value="原邮箱验证码错误",i.error("原邮箱验证码错误"),u.value&&u.value.setFieldError("oldEmailCode","原邮箱验证码错误"))}catch(r){console.error("验证原邮箱验证码失败:",r),c.value=!1,N.value="验证失败，请重试",i.error("验证失败，请重试"),u.value&&u.value.setFieldError("oldEmailCode","验证失败，请重试")}finally{T.value=!1}}},ue=async()=>{if(!a.email||!a.newEmailCode)return;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.email)){i.error("请输入有效的新邮箱");return}if(a.email===f.value){i.error("新邮箱不能与原邮箱相同");return}j.value=!0;try{(await E.auth.verifyNewEmailCode({email:a.email,code:a.newEmailCode})).code===200?(V.value=!0,h.value=!1,i.success("新邮箱验证成功"),u.value&&u.value.clearValidate(["newEmailCode"])):(V.value=!1,i.error("新邮箱验证码错误"),u.value&&u.value.setFieldError("newEmailCode","新邮箱验证码错误"))}catch(e){console.error("验证新邮箱验证码失败:",e),V.value=!1,i.error("验证失败，请重试"),u.value&&u.value.setFieldError("newEmailCode","验证失败，请重试")}finally{j.value=!1}},K=()=>{c.value=!1,V.value=!1,D.value=!1,h.value=!1,F.value=!1,a.oldEmailCode="",a.newEmailCode="",N.value="",a.email="",u.value&&u.value.clearValidate()},me=async()=>{if(!a.email)return;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.email)){i.warning("请输入有效的邮箱地址");return}if(a.email===f.value){i.warning("新邮箱不能与原邮箱相同");return}try{(await E.auth.checkEmailExists(a.email)).data.exists?(i.warning("该邮箱已被使用"),F.value=!1):F.value=!0}catch(e){console.error("检查邮箱唯一性失败:",e),i.error("邮箱验证失败，请重试")}},fe=async()=>{x.value=!0;try{const r=await E.auth.sendOldEmailCode();if(r.code===200){i.success(`验证码已发送到你的原邮箱 ${f.value}，请查收`),q.value=60;const e=setInterval(()=>{q.value--,q.value<=0&&(clearInterval(e),x.value=!1)},1e3)}else i.error(r.message||"验证码发送失败"),x.value=!1}catch(r){i.error(r.message||"验证码发送失败"),x.value=!1}},ve=async()=>{if(!a.email||a.email===f.value){i.error("请输入新邮箱");return}if(!c.value){i.error("请先验证原邮箱");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.email)){i.error("请输入有效的新邮箱");return}R.value=!0;try{const e=await E.auth.sendNewEmailCode(a.email);if(e.code===200){i.success(`验证码已发送到新邮箱 ${a.email}，请查收`),O.value=60;const l=setInterval(()=>{O.value--,O.value<=0&&(clearInterval(l),R.value=!1)},1e3)}else i.error(e.message||"新邮箱验证码发送失败"),R.value=!1}catch(e){i.error(e.message||"验证码发送失败"),R.value=!1}},ce=()=>{B.value=!1,y.username=S.value,U.value&&U.value.clearValidate()},we=()=>{z.value=!0,a.email="",c.value=!1,a.oldEmailCode="",a.newEmailCode="",N.value=""},pe=async()=>{if(U.value){A.value=!0;try{if(await U.value.validate(e=>{if(!e){A.value=!1;return}}),y.username===S.value){i.info("用户名未发生变化"),B.value=!1;return}const r=await E.auth.updateProfileOnly(y.username);r.code===200?(i.success("用户名修改成功"),S.value=y.username,_.username=y.username,B.value=!1):i.error(r.message||"用户名修改失败")}catch(r){i.error(r.message||"用户名修改失败"),console.error("Save username error:",r)}finally{A.value=!1}}},ge=()=>{z.value=!1,a.email=f.value,a.oldEmailCode="",a.newEmailCode="",c.value=!1,N.value="",u.value&&u.value.clearValidate()},ye=async()=>{if(!u.value)return;if(!(a.email!==f.value)){i.info("邮箱未发生变化"),z.value=!1;return}if(!c.value||!V.value){i.error("请先完成所有验证步骤");return}Z.value=!0;try{if(!await u.value.validate()){Z.value=!1;return}const l=await E.auth.verifyChangeEmail({username:y.username,newEmail:a.email,oldEmailCode:a.oldEmailCode,newEmailCode:a.newEmailCode});l.code===200?(i.success(`邮箱修改成功！新邮箱 ${a.email} 已绑定`),f.value=a.email,_.email=a.email,K(),z.value=!1):i.error(l.message||"邮箱修改失败")}catch(e){i.error(e.message||"邮箱修改失败"),console.error("Save email error:",e)}finally{Z.value=!1}},Ee=()=>{I.value=!1,L.value=""},_e=()=>{},Ce=()=>{G.value=!1,d.oldPassword="",d.newPassword="",d.confirmPassword="",I.value=!1,L.value="",$.value&&$.value.clearValidate()},Pe=async()=>{$.value&&(w.oldPassword[0].required=!0,w.newPassword[0].required=!0,w.confirmPassword[0].required=!0,await $.value.validate(async r=>{if(!r){w.oldPassword[0].required=!1,w.newPassword[0].required=!1,w.confirmPassword[0].required=!1;return}if(d.newPassword===d.oldPassword){i.error("新密码不能与原密码相同"),w.oldPassword[0].required=!1,w.newPassword[0].required=!1,w.confirmPassword[0].required=!1;return}J.value=!0;try{const e=await E.auth.changePassword({old_password:d.oldPassword,new_password:d.newPassword});if(e.code===200)i.success("密码修改成功，请重新登录"),d.oldPassword="",d.newPassword="",d.confirmPassword="",I.value=!1,G.value=!1,setTimeout(()=>{E.auth.logout().finally(()=>{localStorage.removeItem("auth_token"),_.isLoggedIn=!1,_.username="",_.email="",_.avatarUrl="",window.location.href="/login"})},2e3);else{let l=e.message||"密码修改失败";l.includes("Old password incorrect")?l="旧密码错误":l.includes("Password must contain")?l="新密码必须包含字母和数字，支持特殊字符":l.includes("Password too short")?l="密码长度必须在8-20个字符之间":l.includes("New password same as old")?l="新密码不能与原密码相同":l.includes("User not found")?l="用户不存在":l.includes("Please log in")&&(l="请先登录"),i.error(l)}}catch(e){i.error("密码修改失败，请检查网络连接或稍后重试"),console.error("Change password error:",e)}finally{J.value=!1,w.oldPassword[0].required=!1,w.newPassword[0].required=!1,w.confirmPassword[0].required=!1}}))};return be(async()=>{await oe()}),(r,e)=>{const l=k("el-button"),p=k("el-input"),b=k("el-form-item"),Q=k("el-form"),ee=k("el-divider"),ae=k("el-card"),le=k("el-icon");return g(),C("div",Re,[s(ae,{class:"profile-card"},{default:t(()=>[e[29]||(e[29]=o("div",{class:"profile-header"},[o("div",{class:"profile-meta"},[o("h2",null,"个人资料"),o("p",null,"管理您的个人信息")])],-1)),o("div",qe,[e[12]||(e[12]=o("div",{class:"info-label"},"用户名",-1)),o("div",Ie,[B.value?(g(),X(Q,{key:1,ref_key:"usernameFormRef",ref:U,model:y,rules:se,"label-position":"top",class:"profile-form edit-form"},{default:t(()=>[s(b,{label:"",prop:"username"},{default:t(()=>[s(p,{modelValue:y.username,"onUpdate:modelValue":e[1]||(e[1]=v=>y.username=v),placeholder:"请输入新用户名"},null,8,["modelValue"])]),_:1}),o("div",Fe,[s(l,{type:"primary",loading:A.value,onClick:pe},{default:t(()=>[...e[10]||(e[10]=[m("保存",-1)])]),_:1},8,["loading"]),s(l,{onClick:ce},{default:t(()=>[...e[11]||(e[11]=[m("取消",-1)])]),_:1})])]),_:1},8,["model"])):(g(),C(H,{key:0},[o("span",Ne,P(y.username||"未设置"),1),s(l,{type:"primary",size:"small",onClick:e[0]||(e[0]=v=>B.value=!0)},{default:t(()=>[...e[9]||(e[9]=[m("修改",-1)])]),_:1})],64))])]),s(ee),o("div",Ue,[e[21]||(e[21]=o("div",{class:"info-label"},"邮箱",-1)),o("div",$e,[z.value?(g(),X(ae,{key:1,class:"email-modification-card"},{default:t(()=>[e[20]||(e[20]=o("h3",null,"修改邮箱",-1)),s(Q,{ref_key:"emailFormRef",ref:u,model:a,rules:re,"label-position":"top",class:"email-modification-form","validate-on-rule-change":!1},{default:t(()=>[c.value?c.value&&!V.value?(g(),C("div",Ze,[s(b,{label:"新邮箱",prop:"email"},{default:t(()=>[s(p,{modelValue:a.email,"onUpdate:modelValue":e[3]||(e[3]=v=>a.email=v),placeholder:"请输入你要绑定的新邮箱",onInput:ie,clearable:"",onBlur:me},null,8,["modelValue"])]),_:1}),s(b,{label:"新邮箱验证码",prop:"newEmailCode"},{default:t(()=>[o("div",Le,[s(p,{modelValue:a.newEmailCode,"onUpdate:modelValue":e[4]||(e[4]=v=>a.newEmailCode=v),placeholder:"请输入新邮箱收到的验证码",maxlength:"6",onInput:ne},null,8,["modelValue"]),s(l,{type:"primary",disabled:!F.value||R.value,onClick:ve},{default:t(()=>[m(P(R.value?"发送中...":O.value>0?`重新发送(${O.value}s)`:"获取新邮箱验证码"),1)]),_:1},8,["disabled"])])]),_:1}),o("div",Te,[s(l,{type:"primary",disabled:!h.value||j.value,onClick:ue},{default:t(()=>[m(P(j.value?"验证中...":"验证新邮箱"),1)]),_:1},8,["disabled"]),s(l,{onClick:K},{default:t(()=>[...e[15]||(e[15]=[m("返回重新验证原邮箱",-1)])]),_:1})])])):c.value&&V.value?(g(),C("div",je,[o("div",De,[o("div",Ge,[e[16]||(e[16]=o("span",{class:"summary-label"},"原邮箱：",-1)),o("span",He,P(f.value.value||M(_).email),1)]),o("div",Je,[e[17]||(e[17]=o("span",{class:"summary-label"},"新邮箱：",-1)),o("span",Ke,P(a.email),1)])]),o("div",Qe,[s(l,{type:"primary",loading:Z.value,onClick:ye},{default:t(()=>[...e[18]||(e[18]=[m(" 确认修改邮箱 ",-1)])]),_:1},8,["loading"]),s(l,{onClick:K},{default:t(()=>[...e[19]||(e[19]=[m("取消修改",-1)])]),_:1})])])):Y("",!0):(g(),C("div",Se,[s(b,{label:"原邮箱"},{default:t(()=>[o("div",Be,[o("span",ze,P(f.value.value||M(_).email||"未设置"),1)])]),_:1}),s(b,{label:"原邮箱验证码",prop:"oldEmailCode"},{default:t(()=>[o("div",Me,[s(p,{modelValue:a.oldEmailCode,"onUpdate:modelValue":e[2]||(e[2]=v=>a.oldEmailCode=v),placeholder:"请输入原邮箱收到的验证码",maxlength:"6",onInput:te},null,8,["modelValue"]),s(l,{type:"primary",disabled:x.value||q.value>0,onClick:fe},{default:t(()=>[m(P(x.value?"发送中...":q.value>0?`重新发送(${q.value}s)`:"获取原邮箱验证码"),1)]),_:1},8,["disabled"])])]),_:1}),o("div",Ae,[s(l,{type:"primary",disabled:!D.value||T.value,onClick:de},{default:t(()=>[m(P(T.value?"验证中...":"验证身份"),1)]),_:1},8,["disabled"]),s(l,{onClick:ge},{default:t(()=>[...e[14]||(e[14]=[m("取消",-1)])]),_:1})])]))]),_:1},8,["model"])]),_:1})):(g(),C(H,{key:0},[o("span",Oe,P(f.value.value||M(_).email||"未设置"),1),s(l,{type:"primary",size:"small",onClick:we},{default:t(()=>[...e[13]||(e[13]=[m("修改",-1)])]),_:1})],64))])]),s(ee),o("div",We,[e[28]||(e[28]=o("div",{class:"info-label"},"密码",-1)),o("div",Xe,[G.value?(g(),X(Q,{key:1,ref_key:"passwordFormRef",ref:$,model:d,rules:w,"label-position":"top",class:"password-form edit-form","validate-on-rule-change":!1},{default:t(()=>[e[27]||(e[27]=o("h4",null,"修改密码",-1)),s(b,{label:"旧密码",prop:"oldPassword"},{default:t(()=>[o("div",Ye,[s(p,{modelValue:d.oldPassword,"onUpdate:modelValue":e[6]||(e[6]=v=>d.oldPassword=v),type:"password","show-password":"",placeholder:"请输入旧密码",onBlur:_e,onInput:Ee},null,8,["modelValue"])]),L.value?(g(),C("div",ea,[s(le,null,{default:t(()=>[s(M(ke))]),_:1}),m(" "+P(L.value),1)])):I.value&&d.oldPassword?(g(),C("div",aa,[s(le,null,{default:t(()=>[s(M(xe))]),_:1}),e[24]||(e[24]=m(" 旧密码验证成功，可以设置新密码 ",-1))])):Y("",!0)]),_:1}),I.value?(g(),C(H,{key:0},[s(b,{label:"新密码",prop:"newPassword"},{default:t(()=>[s(p,{modelValue:d.newPassword,"onUpdate:modelValue":e[7]||(e[7]=v=>d.newPassword=v),type:"password","show-password":"",placeholder:"请输入新密码"},null,8,["modelValue"])]),_:1}),s(b,{label:"确认新密码",prop:"confirmPassword"},{default:t(()=>[s(p,{modelValue:d.confirmPassword,"onUpdate:modelValue":e[8]||(e[8]=v=>d.confirmPassword=v),type:"password","show-password":"",placeholder:"请再次输入新密码"},null,8,["modelValue"])]),_:1})],64)):Y("",!0),o("div",la,[s(l,{type:"primary",loading:J.value,onClick:Pe,disabled:!I.value||!d.newPassword||!d.confirmPassword},{default:t(()=>[...e[25]||(e[25]=[m(" 保存 ",-1)])]),_:1},8,["loading","disabled"]),s(l,{type:"default",onClick:Ce},{default:t(()=>[...e[26]||(e[26]=[m(" 取消 ",-1)])]),_:1})])]),_:1},8,["model"])):(g(),C(H,{key:0},[e[23]||(e[23]=o("span",{class:"current-value"},"********",-1)),s(l,{type:"primary",size:"small",onClick:e[5]||(e[5]=v=>G.value=!0)},{default:t(()=>[...e[22]||(e[22]=[m("修改",-1)])]),_:1})],64))])])]),_:1})])}}},ia=Ve(sa,[["__scopeId","data-v-9e64ac2e"]]);export{ia as default};
