import{g as he,d as ge,u as ye,c as Ve,a as G,s as J}from"./publishPlans-GE3Pv3cx.js";import{g as we}from"./merchants-DMPUAaz6.js";import{g as ke}from"./videoLibrary-Otxr5QV_.js";import{_ as xe,r as p,l as Ce,n as Pe,c as x,b as _,e as l,w as t,f as u,E as f,s as ze,d as D,v as K,h as s,i as U,t as Y,F as q,p as H,j as De,H as Ue}from"./index-Cc1A4YXN.js";const Ie={class:"publish-plan-page"},Me={class:"card-header"},Ye={class:"filters"},Se={class:"pagination"},Te={key:0},qe={style:{width:"100%"}},He={key:0,style:{"margin-top":"8px"}},Be={key:1},Ee={__name:"PublishPlan",setup(Le){const S=p(!1),B=p([]),E=p([]),b=p({platform:"",status:"",search:""}),c=p({page:1,size:20,total:0}),C=p(!1),n=p({id:null,plan_name:"",platform:"douyin",merchant_id:null,distribution_mode:"manual",publish_time:"",publish_mode:"batch"}),g=p([]),I=p(!1),y=p([]),w=p([]),M=p(""),Q=Ce(()=>n.value.id?"编辑发布计划":"新建发布计划"),R=o=>({douyin:"抖音",kuaishou:"快手",xiaohongshu:"小红书"})[o]||o,W=o=>({manual:"手动分发",sms:"接收短信派发",qrcode:"扫二维码派发",ai:"AI智能分发"})[o]||o,X=o=>({pending:"待发布",publishing:"发布中",completed:"发布成功",failed:"发布失败"})[o]||o,Z=o=>({pending:"warning",publishing:"info",completed:"success",failed:"danger"})[o]||"info",k=async()=>{try{S.value=!0;const o={platform:b.value.platform||void 0,status:b.value.status||void 0,limit:c.value.size,offset:(c.value.page-1)*c.value.size},e=await he(o);e.code===200&&(B.value=e.data.plans,c.value.total=e.data.total)}catch(o){f.error("加载发布计划失败"),console.error(o)}finally{S.value=!1}},ee=async()=>{try{const o=await we({limit:100});o.code===200&&(E.value=o.data.merchants)}catch(o){console.error("加载商家列表失败:",o)}},le=()=>{b.value={platform:"",status:"",search:""},k()},ae=o=>{c.value.size=o,c.value.page=1,k()},te=o=>{c.value.page=o,k()},oe=()=>{n.value={id:null,plan_name:"",platform:"douyin",merchant_id:null,distribution_mode:"manual",publish_time:"",publish_mode:"batch"},y.value=[],w.value=[],M.value="",C.value=!0},ie=o=>{n.value={id:o.id,plan_name:o.plan_name,platform:o.platform,merchant_id:o.merchant_id,distribution_mode:o.distribution_mode,publish_time:o.publish_time?new Date(o.publish_time).toISOString().slice(0,19).replace("T"," "):""},C.value=!0},ne=async o=>{try{await Ue.confirm("确定要删除该发布计划吗？","提示",{type:"warning"}),(await ge(o.id)).code===200&&(f.success("删除成功"),k())}catch(e){e!=="cancel"&&(f.error("删除失败"),console.error(e))}},de=async()=>{var o;if(!n.value.plan_name){f.warning("请输入计划名称");return}if(n.value.publish_mode==="phased"){if(y.value.some(v=>!v.video_id||!v.schedule_time)){f.warning("分阶段需为每行选择视频并设置时间");return}}else if(!w.value||w.value.length===0){f.warning("请至少选择一个视频");return}try{const e={plan_name:n.value.plan_name,platform:n.value.platform,merchant_id:n.value.merchant_id||void 0,distribution_mode:n.value.distribution_mode,publish_time:n.value.publish_time||void 0};let v;if(n.value.id?v=await ye(n.value.id,e):v=await Ve(e),v.code===200||v.code===201){const V=n.value.id?n.value.id:(o=v.data)==null?void 0:o.id;if(!V)f.warning("计划创建成功但未获取到ID");else if(n.value.publish_mode==="phased"){for(const d of y.value){const i=g.value.find(r=>r.id===d.video_id);i&&await G(V,{video_url:i.video_url,video_title:i.video_name||"",thumbnail_url:i.thumbnail_url||""})}await J(V,{publish_schedule:{mode:"phased",items:y.value.map(d=>{const i=g.value.find(r=>r.id===d.video_id);return{video_id:d.video_id,video_url:i==null?void 0:i.video_url,schedule_time:d.schedule_time}})}})}else{for(const d of w.value){const i=g.value.find(r=>r.id===d);i&&await G(V,{video_url:i.video_url,video_title:i.video_name||"",thumbnail_url:i.thumbnail_url||""})}await J(V,{publish_schedule:{mode:"batch",items:w.value.map(d=>{const i=g.value.find(r=>r.id===d);return{video_id:d,video_url:i==null?void 0:i.video_url}}),batch_time:M.value||n.value.publish_time||""}})}f.success(n.value.id?"更新成功":"创建成功"),C.value=!1,k()}else f.error(v.message||(n.value.id?"更新失败":"创建失败"))}catch(e){f.error(n.value.id?"更新失败":"创建失败"),console.error(e)}};Pe(()=>{k(),ee(),L()});const L=async()=>{var o;try{I.value=!0;const e=await ke({limit:200});e.code===200&&(g.value=((o=e.data)==null?void 0:o.videos)||[])}catch(e){console.error("加载视频库失败",e)}finally{I.value=!1}},N=o=>{o&&g.value.length===0&&!I.value&&L()},ue=()=>{y.value.push({video_id:null,schedule_time:""})},se=o=>{y.value.splice(o,1)};return(o,e)=>{const v=u("Plus"),V=u("el-icon"),d=u("el-button"),i=u("el-option"),r=u("el-select"),re=u("Search"),$=u("el-input"),m=u("el-table-column"),F=u("el-tag"),j=u("el-table"),me=u("el-pagination"),pe=u("el-card"),h=u("el-form-item"),T=u("el-date-picker"),_e=u("el-divider"),A=u("el-radio"),ve=u("el-radio-group"),ce=u("el-text"),fe=u("el-form"),be=u("el-dialog"),O=ze("loading");return _(),x("div",Ie,[l(pe,{shadow:"never"},{header:t(()=>[D("div",Me,[e[14]||(e[14]=D("h3",null,"发布计划管理",-1)),l(d,{type:"primary",onClick:oe},{default:t(()=>[l(V,null,{default:t(()=>[l(v)]),_:1}),e[13]||(e[13]=s(" 新建发布计划 ",-1))]),_:1})])]),default:t(()=>[D("div",Ye,[l(r,{modelValue:b.value.platform,"onUpdate:modelValue":e[0]||(e[0]=a=>b.value.platform=a),placeholder:"选择平台",clearable:"",style:{width:"150px","margin-right":"10px"}},{default:t(()=>[l(i,{label:"抖音",value:"douyin"}),l(i,{label:"快手",value:"kuaishou"}),l(i,{label:"小红书",value:"xiaohongshu"})]),_:1},8,["modelValue"]),l(r,{modelValue:b.value.status,"onUpdate:modelValue":e[1]||(e[1]=a=>b.value.status=a),placeholder:"选择状态",clearable:"",style:{width:"150px","margin-right":"10px"}},{default:t(()=>[l(i,{label:"待发布",value:"pending"}),l(i,{label:"发布中",value:"publishing"}),l(i,{label:"发布成功",value:"completed"}),l(i,{label:"发布失败",value:"failed"})]),_:1},8,["modelValue"]),l($,{modelValue:b.value.search,"onUpdate:modelValue":e[2]||(e[2]=a=>b.value.search=a),placeholder:"搜索计划名称",style:{width:"250px","margin-right":"10px"},clearable:""},{prefix:t(()=>[l(V,null,{default:t(()=>[l(re)]),_:1})]),_:1},8,["modelValue"]),l(d,{type:"primary",onClick:k},{default:t(()=>[...e[15]||(e[15]=[s("查询",-1)])]),_:1}),l(d,{onClick:le},{default:t(()=>[...e[16]||(e[16]=[s("重置",-1)])]),_:1})]),K((_(),U(j,{data:B.value,stripe:"",style:{width:"100%","margin-top":"20px"}},{default:t(()=>[l(m,{prop:"id",label:"计划ID",width:"100"}),l(m,{prop:"plan_name",label:"计划名称","min-width":"200"}),l(m,{prop:"platform",label:"平台",width:"100"},{default:t(({row:a})=>[l(F,null,{default:t(()=>[s(Y(R(a.platform)),1)]),_:2},1024)]),_:1}),l(m,{prop:"merchant_name",label:"关联商家",width:"150"}),l(m,{prop:"video_count",label:"视频数",width:"100"}),l(m,{prop:"published_count",label:"已发布",width:"100"}),l(m,{prop:"pending_count",label:"待发布",width:"100"}),l(m,{prop:"distribution_mode",label:"分发模式",width:"150"},{default:t(({row:a})=>[s(Y(W(a.distribution_mode)),1)]),_:1}),l(m,{prop:"status",label:"状态",width:"120"},{default:t(({row:a})=>[l(F,{type:Z(a.status)},{default:t(()=>[s(Y(X(a.status)),1)]),_:2},1032,["type"])]),_:1}),l(m,{prop:"publish_time",label:"发布时间",width:"180"},{default:t(({row:a})=>[s(Y(a.publish_time?new Date(a.publish_time).toLocaleString("zh-CN"):"-"),1)]),_:1}),l(m,{label:"操作",width:"200",fixed:"right"},{default:t(({row:a})=>[l(d,{link:"",type:"primary",size:"small",onClick:z=>ie(a)},{default:t(()=>[...e[17]||(e[17]=[s("编辑",-1)])]),_:1},8,["onClick"]),l(d,{link:"",type:"danger",size:"small",onClick:z=>ne(a)},{default:t(()=>[...e[18]||(e[18]=[s("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[O,S.value]]),D("div",Se,[l(me,{"current-page":c.value.page,"page-size":c.value.size,total:c.value.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ae,onCurrentChange:te},null,8,["current-page","page-size","total"])])]),_:1}),l(be,{modelValue:C.value,"onUpdate:modelValue":e[12]||(e[12]=a=>C.value=a),title:Q.value,width:"600px"},{footer:t(()=>[l(d,{onClick:e[11]||(e[11]=a=>C.value=!1)},{default:t(()=>[...e[25]||(e[25]=[s("取消",-1)])]),_:1}),l(d,{type:"primary",onClick:de},{default:t(()=>[...e[26]||(e[26]=[s("确定",-1)])]),_:1})]),default:t(()=>[l(fe,{model:n.value,"label-width":"120px"},{default:t(()=>[l(h,{label:"计划名称",required:""},{default:t(()=>[l($,{modelValue:n.value.plan_name,"onUpdate:modelValue":e[3]||(e[3]=a=>n.value.plan_name=a),placeholder:"请输入计划名称"},null,8,["modelValue"])]),_:1}),l(h,{label:"平台",required:""},{default:t(()=>[l(r,{modelValue:n.value.platform,"onUpdate:modelValue":e[4]||(e[4]=a=>n.value.platform=a),placeholder:"请选择平台",style:{width:"100%"}},{default:t(()=>[l(i,{label:"抖音",value:"douyin"}),l(i,{label:"快手",value:"kuaishou"}),l(i,{label:"小红书",value:"xiaohongshu"})]),_:1},8,["modelValue"])]),_:1}),l(h,{label:"关联商家"},{default:t(()=>[l(r,{modelValue:n.value.merchant_id,"onUpdate:modelValue":e[5]||(e[5]=a=>n.value.merchant_id=a),placeholder:"请选择商家",clearable:"",style:{width:"100%"}},{default:t(()=>[(_(!0),x(q,null,H(E.value,a=>(_(),U(i,{key:a.id,label:a.merchant_name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(h,{label:"分发模式"},{default:t(()=>[l(r,{modelValue:n.value.distribution_mode,"onUpdate:modelValue":e[6]||(e[6]=a=>n.value.distribution_mode=a),placeholder:"请选择分发模式",style:{width:"100%"}},{default:t(()=>[l(i,{label:"手动分发",value:"manual"}),l(i,{label:"接收短信派发",value:"sms"}),l(i,{label:"扫二维码派发",value:"qrcode"}),l(i,{label:"AI智能分发",value:"ai"})]),_:1},8,["modelValue"])]),_:1}),l(h,{label:"发布时间"},{default:t(()=>[l(T,{modelValue:n.value.publish_time,"onUpdate:modelValue":e[7]||(e[7]=a=>n.value.publish_time=a),type:"datetime",placeholder:"选择发布时间",style:{width:"100%"},"value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),l(_e,null,{default:t(()=>[...e[19]||(e[19]=[s("视频与发布方式",-1)])]),_:1}),l(h,{label:"发布方式",required:""},{default:t(()=>[l(ve,{modelValue:n.value.publish_mode,"onUpdate:modelValue":e[8]||(e[8]=a=>n.value.publish_mode=a)},{default:t(()=>[l(A,{label:"phased"},{default:t(()=>[...e[20]||(e[20]=[s("分阶段（按固定时间逐个发出）",-1)])]),_:1}),l(A,{label:"batch"},{default:t(()=>[...e[21]||(e[21]=[s("分批次（一次选择多个视频）",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),n.value.publish_mode==="phased"?(_(),x("div",Te,[l(h,{label:"阶段列表",required:""},{default:t(()=>[D("div",qe,[l(d,{type:"primary",link:"",onClick:ue,style:{"margin-bottom":"8px"}},{default:t(()=>[...e[22]||(e[22]=[s("添加阶段",-1)])]),_:1}),K((_(),U(j,{data:y.value,size:"small",style:{width:"100%"}},{default:t(()=>[l(m,{label:"视频","min-width":"220"},{default:t(({row:a,$index:z})=>[l(r,{modelValue:a.video_id,"onUpdate:modelValue":P=>a.video_id=P,placeholder:"选择视频",filterable:"",style:{width:"100%"},onVisibleChange:N},{default:t(()=>[(_(!0),x(q,null,H(g.value,P=>(_(),U(i,{key:P.id,label:P.video_name||P.video_url,value:P.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),l(m,{label:"发布时间",width:"240"},{default:t(({row:a})=>[l(T,{modelValue:a.schedule_time,"onUpdate:modelValue":z=>a.schedule_time=z,type:"datetime",placeholder:"选择时间","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),l(m,{label:"操作",width:"120"},{default:t(({$index:a})=>[l(d,{link:"",type:"danger",size:"small",onClick:z=>se(a)},{default:t(()=>[...e[23]||(e[23]=[s("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[O,I.value]]),y.value.length===0?(_(),x("div",He,[l(ce,{type:"info",size:"small"},{default:t(()=>[...e[24]||(e[24]=[s("请添加至少一个阶段并选择视频与时间",-1)])]),_:1})])):De("",!0)])]),_:1})])):(_(),x("div",Be,[l(h,{label:"选择视频",required:""},{default:t(()=>[l(r,{modelValue:w.value,"onUpdate:modelValue":e[9]||(e[9]=a=>w.value=a),multiple:"",filterable:"",placeholder:"从视频库选择多个视频",style:{width:"100%"},onVisibleChange:N},{default:t(()=>[(_(!0),x(q,null,H(g.value,a=>(_(),U(i,{key:a.id,label:a.video_name||a.video_url,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(h,{label:"批次统一时间"},{default:t(()=>[l(T,{modelValue:M.value,"onUpdate:modelValue":e[10]||(e[10]=a=>M.value=a),type:"datetime",placeholder:"不选则使用上方发布时间或立即",style:{width:"100%"},"value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]))]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Ae=xe(Ee,[["__scopeId","data-v-8bf25a30"]]);export{Ae as default};
