import{g as ye,d as Ve,u as we,c as ke,a as K,s as Q}from"./publishPlans-CdX2cvvl.js";import{g as xe}from"./merchants-BRLEUHtm.js";import{g as Ce}from"./videoLibrary-lGvTVaWW.js";import{_ as Pe,r as _,c as ze,w as De,o as Ue,a as k,b as p,d as l,f as t,g as d,E as c,p as Ie,e as I,q as R,l as s,j as z,t as Y,F as S,i as q,k as Me,D as Ye,n as Se}from"./index-DyjCXijH.js";const qe={class:"publish-plan-page"},Te={class:"card-header"},He={class:"filters"},Be={class:"pagination"},Ee={key:0},Le={style:{width:"100%"}},Ne={key:0,style:{"margin-top":"8px"}},$e={key:1},Ae={__name:"PublishPlan",setup(Fe){const T=_(!1),E=_([]),L=_([]),N=_([]),h=_({platform:"",status:"",search:""}),f=_({page:1,size:20,total:0}),C=_(!1),i=_({id:null,plan_name:"",platform:"douyin",merchant_id:null,distribution_mode:"manual",publish_time:"",publish_mode:"batch",account_ids:[]}),y=_([]),M=_(!1),g=_([]),V=_([]),D=_(""),W=ze(()=>i.value.id?"编辑发布计划":"新建发布计划"),X=o=>({douyin:"抖音",kuaishou:"快手",xiaohongshu:"小红书"})[o]||o,Z=o=>({manual:"手动分发",sms:"接收短信派发",qrcode:"扫二维码派发",ai:"AI智能分发"})[o]||o,ee=o=>({pending:"待发布",publishing:"发布中",completed:"发布成功",failed:"发布失败"})[o]||o,le=o=>({pending:"warning",publishing:"info",completed:"success",failed:"danger"})[o]||"info",x=async()=>{try{T.value=!0;const o={platform:h.value.platform||void 0,status:h.value.status||void 0,limit:f.value.size,offset:(f.value.page-1)*f.value.size},e=await ye(o);e.code===200&&(E.value=e.data.plans,f.value.total=e.data.total)}catch(o){c.error("加载发布计划失败"),console.error(o)}finally{T.value=!1}},ae=async()=>{try{const o=await xe({limit:100});o.code===200&&(L.value=o.data.merchants)}catch(o){console.error("加载商家列表失败:",o)}},H=async(o="douyin")=>{try{const e=await Se.accounts.list({platform:o,limit:100});e.code===200&&(N.value=e.data.accounts)}catch(e){console.error("加载账号列表失败:",e)}},te=()=>{h.value={platform:"",status:"",search:""},x()},oe=o=>{f.value.size=o,f.value.page=1,x()},ie=o=>{f.value.page=o,x()},ne=()=>{i.value={id:null,plan_name:"",platform:"douyin",merchant_id:null,distribution_mode:"manual",publish_time:"",publish_mode:"batch",account_ids:[]},g.value=[],V.value=[],D.value="",H("douyin"),C.value=!0},ue=o=>{i.value={id:o.id,plan_name:o.plan_name,platform:o.platform,merchant_id:o.merchant_id,distribution_mode:o.distribution_mode,publish_time:o.publish_time?new Date(o.publish_time).toISOString().slice(0,19).replace("T"," "):"",publish_mode:"batch",account_ids:[]},g.value=[],V.value=[],D.value="",H(o.platform),C.value=!0},de=async o=>{try{await Ye.confirm("确定要删除该发布计划吗？","提示",{type:"warning"}),(await Ve(o.id)).code===200&&(c.success("删除成功"),x())}catch(e){e!=="cancel"&&(c.error("删除失败"),console.error(e))}},se=async()=>{var o;if(!i.value.plan_name){c.warning("请输入计划名称");return}if(!i.value.account_ids||i.value.account_ids.length===0){c.warning("请至少选择一个账号");return}if(i.value.publish_mode==="phased"){if(g.value.some(v=>!v.video_id||!v.schedule_time)){c.warning("分阶段需为每行选择视频并设置时间");return}}else if(!V.value||V.value.length===0){c.warning("请至少选择一个视频");return}try{const e={plan_name:i.value.plan_name,platform:i.value.platform,merchant_id:i.value.merchant_id||void 0,distribution_mode:i.value.distribution_mode,publish_time:i.value.publish_time||void 0,account_ids:i.value.account_ids};let v;if(i.value.id?v=await we(i.value.id,e):v=await ke(e),v.code===200||v.code===201){const w=i.value.id?i.value.id:(o=v.data)==null?void 0:o.id;if(!w)c.warning("计划创建成功但未获取到ID");else if(i.value.publish_mode==="phased"){for(const u of g.value){const n=y.value.find(r=>r.id===u.video_id);n&&await K(w,{video_url:n.video_url,video_title:n.video_name||"",thumbnail_url:n.thumbnail_url||""})}await Q(w,{publish_schedule:{mode:"phased",items:g.value.map(u=>{const n=y.value.find(r=>r.id===u.video_id);return{video_id:u.video_id,video_url:n==null?void 0:n.video_url,schedule_time:u.schedule_time}})}})}else{for(const u of V.value){const n=y.value.find(r=>r.id===u);n&&await K(w,{video_url:n.video_url,video_title:n.video_name||"",thumbnail_url:n.thumbnail_url||""})}await Q(w,{publish_schedule:{mode:"batch",items:V.value.map(u=>{const n=y.value.find(r=>r.id===u);return{video_id:u,video_url:n==null?void 0:n.video_url}}),batch_time:D.value||i.value.publish_time||""}})}c.success(i.value.id?"更新成功":"创建成功"),C.value=!1,x()}else c.error(v.message||(i.value.id?"更新失败":"创建失败"))}catch(e){c.error(i.value.id?"更新失败":"创建失败"),console.error(e)}};De(()=>i.value.platform,o=>{H(o),i.value.account_ids=[]}),Ue(()=>{x(),ae(),$()});const $=async()=>{var o;try{M.value=!0;const e=await Ce({limit:200});e.code===200&&(y.value=((o=e.data)==null?void 0:o.videos)||[])}catch(e){console.error("加载视频库失败",e)}finally{M.value=!1}},A=o=>{o&&y.value.length===0&&!M.value&&$()},re=()=>{g.value.push({video_id:null,schedule_time:""})},me=o=>{g.value.splice(o,1)};return(o,e)=>{const v=d("Plus"),w=d("el-icon"),u=d("el-button"),n=d("el-option"),r=d("el-select"),pe=d("Search"),F=d("el-input"),m=d("el-table-column"),j=d("el-tag"),O=d("el-table"),_e=d("el-pagination"),ve=d("el-card"),b=d("el-form-item"),B=d("el-date-picker"),ce=d("el-divider"),G=d("el-radio"),fe=d("el-radio-group"),be=d("el-text"),he=d("el-form"),ge=d("el-dialog"),J=Ie("loading");return p(),k("div",qe,[l(ve,{shadow:"never"},{header:t(()=>[I("div",Te,[e[15]||(e[15]=I("h3",null,"发布计划管理",-1)),l(u,{type:"primary",onClick:ne},{default:t(()=>[l(w,null,{default:t(()=>[l(v)]),_:1}),e[14]||(e[14]=s(" 新建发布计划 ",-1))]),_:1})])]),default:t(()=>[I("div",He,[l(r,{modelValue:h.value.platform,"onUpdate:modelValue":e[0]||(e[0]=a=>h.value.platform=a),placeholder:"选择平台",clearable:"",style:{width:"150px","margin-right":"10px"}},{default:t(()=>[l(n,{label:"抖音",value:"douyin"}),l(n,{label:"快手",value:"kuaishou"}),l(n,{label:"小红书",value:"xiaohongshu"})]),_:1},8,["modelValue"]),l(r,{modelValue:h.value.status,"onUpdate:modelValue":e[1]||(e[1]=a=>h.value.status=a),placeholder:"选择状态",clearable:"",style:{width:"150px","margin-right":"10px"}},{default:t(()=>[l(n,{label:"待发布",value:"pending"}),l(n,{label:"发布中",value:"publishing"}),l(n,{label:"发布成功",value:"completed"}),l(n,{label:"发布失败",value:"failed"})]),_:1},8,["modelValue"]),l(F,{modelValue:h.value.search,"onUpdate:modelValue":e[2]||(e[2]=a=>h.value.search=a),placeholder:"搜索计划名称",style:{width:"250px","margin-right":"10px"},clearable:""},{prefix:t(()=>[l(w,null,{default:t(()=>[l(pe)]),_:1})]),_:1},8,["modelValue"]),l(u,{type:"primary",onClick:x},{default:t(()=>[...e[16]||(e[16]=[s("查询",-1)])]),_:1}),l(u,{onClick:te},{default:t(()=>[...e[17]||(e[17]=[s("重置",-1)])]),_:1})]),R((p(),z(O,{data:E.value,stripe:"",style:{width:"100%","margin-top":"20px"}},{default:t(()=>[l(m,{prop:"id",label:"计划ID",width:"100"}),l(m,{prop:"plan_name",label:"计划名称","min-width":"200"}),l(m,{prop:"platform",label:"平台",width:"100"},{default:t(({row:a})=>[l(j,null,{default:t(()=>[s(Y(X(a.platform)),1)]),_:2},1024)]),_:1}),l(m,{prop:"merchant_name",label:"关联商家",width:"150"}),l(m,{prop:"video_count",label:"视频数",width:"100"}),l(m,{prop:"published_count",label:"已发布",width:"100"}),l(m,{prop:"pending_count",label:"待发布",width:"100"}),l(m,{prop:"distribution_mode",label:"分发模式",width:"150"},{default:t(({row:a})=>[s(Y(Z(a.distribution_mode)),1)]),_:1}),l(m,{prop:"status",label:"状态",width:"120"},{default:t(({row:a})=>[l(j,{type:le(a.status)},{default:t(()=>[s(Y(ee(a.status)),1)]),_:2},1032,["type"])]),_:1}),l(m,{prop:"publish_time",label:"发布时间",width:"180"},{default:t(({row:a})=>[s(Y(a.publish_time?new Date(a.publish_time).toLocaleString("zh-CN"):"-"),1)]),_:1}),l(m,{label:"操作",width:"200",fixed:"right"},{default:t(({row:a})=>[l(u,{link:"",type:"primary",size:"small",onClick:U=>ue(a)},{default:t(()=>[...e[18]||(e[18]=[s("编辑",-1)])]),_:1},8,["onClick"]),l(u,{link:"",type:"danger",size:"small",onClick:U=>de(a)},{default:t(()=>[...e[19]||(e[19]=[s("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[J,T.value]]),I("div",Be,[l(_e,{"current-page":f.value.page,"page-size":f.value.size,total:f.value.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:oe,onCurrentChange:ie},null,8,["current-page","page-size","total"])])]),_:1}),l(ge,{modelValue:C.value,"onUpdate:modelValue":e[13]||(e[13]=a=>C.value=a),title:W.value,width:"600px"},{footer:t(()=>[l(u,{onClick:e[12]||(e[12]=a=>C.value=!1)},{default:t(()=>[...e[26]||(e[26]=[s("取消",-1)])]),_:1}),l(u,{type:"primary",onClick:se},{default:t(()=>[...e[27]||(e[27]=[s("确定",-1)])]),_:1})]),default:t(()=>[l(he,{model:i.value,"label-width":"120px"},{default:t(()=>[l(b,{label:"计划名称",required:""},{default:t(()=>[l(F,{modelValue:i.value.plan_name,"onUpdate:modelValue":e[3]||(e[3]=a=>i.value.plan_name=a),placeholder:"请输入计划名称"},null,8,["modelValue"])]),_:1}),l(b,{label:"平台",required:""},{default:t(()=>[l(r,{modelValue:i.value.platform,"onUpdate:modelValue":e[4]||(e[4]=a=>i.value.platform=a),placeholder:"请选择平台",style:{width:"100%"}},{default:t(()=>[l(n,{label:"抖音",value:"douyin"}),l(n,{label:"快手",value:"kuaishou"}),l(n,{label:"小红书",value:"xiaohongshu"})]),_:1},8,["modelValue"])]),_:1}),l(b,{label:"关联商家"},{default:t(()=>[l(r,{modelValue:i.value.merchant_id,"onUpdate:modelValue":e[5]||(e[5]=a=>i.value.merchant_id=a),placeholder:"请选择商家",clearable:"",style:{width:"100%"}},{default:t(()=>[(p(!0),k(S,null,q(L.value,a=>(p(),z(n,{key:a.id,label:a.merchant_name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(b,{label:"选择账号",required:""},{default:t(()=>[l(r,{modelValue:i.value.account_ids,"onUpdate:modelValue":e[6]||(e[6]=a=>i.value.account_ids=a),multiple:"",filterable:"",placeholder:"请选择要使用的账号（可多选）",style:{width:"100%"}},{default:t(()=>[(p(!0),k(S,null,q(N.value,a=>(p(),z(n,{key:a.id,label:a.account_name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(b,{label:"分发模式"},{default:t(()=>[l(r,{modelValue:i.value.distribution_mode,"onUpdate:modelValue":e[7]||(e[7]=a=>i.value.distribution_mode=a),placeholder:"请选择分发模式",style:{width:"100%"}},{default:t(()=>[l(n,{label:"手动分发",value:"manual"}),l(n,{label:"接收短信派发",value:"sms"}),l(n,{label:"扫二维码派发",value:"qrcode"}),l(n,{label:"AI智能分发",value:"ai"})]),_:1},8,["modelValue"])]),_:1}),l(b,{label:"发布时间"},{default:t(()=>[l(B,{modelValue:i.value.publish_time,"onUpdate:modelValue":e[8]||(e[8]=a=>i.value.publish_time=a),type:"datetime",placeholder:"选择发布时间",style:{width:"100%"},"value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),l(ce,null,{default:t(()=>[...e[20]||(e[20]=[s("视频与发布方式",-1)])]),_:1}),l(b,{label:"发布方式",required:""},{default:t(()=>[l(fe,{modelValue:i.value.publish_mode,"onUpdate:modelValue":e[9]||(e[9]=a=>i.value.publish_mode=a)},{default:t(()=>[l(G,{label:"phased"},{default:t(()=>[...e[21]||(e[21]=[s("分阶段（按固定时间逐个发出）",-1)])]),_:1}),l(G,{label:"batch"},{default:t(()=>[...e[22]||(e[22]=[s("分批次（一次选择多个视频）",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),i.value.publish_mode==="phased"?(p(),k("div",Ee,[l(b,{label:"阶段列表",required:""},{default:t(()=>[I("div",Le,[l(u,{type:"primary",link:"",onClick:re,style:{"margin-bottom":"8px"}},{default:t(()=>[...e[23]||(e[23]=[s("添加阶段",-1)])]),_:1}),R((p(),z(O,{data:g.value,size:"small",style:{width:"100%"}},{default:t(()=>[l(m,{label:"视频","min-width":"220"},{default:t(({row:a,$index:U})=>[l(r,{modelValue:a.video_id,"onUpdate:modelValue":P=>a.video_id=P,placeholder:"选择视频",filterable:"",style:{width:"100%"},onVisibleChange:A},{default:t(()=>[(p(!0),k(S,null,q(y.value,P=>(p(),z(n,{key:P.id,label:P.video_name||P.video_url,value:P.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),l(m,{label:"发布时间",width:"240"},{default:t(({row:a})=>[l(B,{modelValue:a.schedule_time,"onUpdate:modelValue":U=>a.schedule_time=U,type:"datetime",placeholder:"选择时间","value-format":"YYYY-MM-DD HH:mm:ss",style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),l(m,{label:"操作",width:"120"},{default:t(({$index:a})=>[l(u,{link:"",type:"danger",size:"small",onClick:U=>me(a)},{default:t(()=>[...e[24]||(e[24]=[s("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[J,M.value]]),g.value.length===0?(p(),k("div",Ne,[l(be,{type:"info",size:"small"},{default:t(()=>[...e[25]||(e[25]=[s("请添加至少一个阶段并选择视频与时间",-1)])]),_:1})])):Me("",!0)])]),_:1})])):(p(),k("div",$e,[l(b,{label:"选择视频",required:""},{default:t(()=>[l(r,{modelValue:V.value,"onUpdate:modelValue":e[10]||(e[10]=a=>V.value=a),multiple:"",filterable:"",placeholder:"从视频库选择多个视频",style:{width:"100%"},onVisibleChange:A},{default:t(()=>[(p(!0),k(S,null,q(y.value,a=>(p(),z(n,{key:a.id,label:a.video_name||a.video_url,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(b,{label:"批次统一时间"},{default:t(()=>[l(B,{modelValue:D.value,"onUpdate:modelValue":e[11]||(e[11]=a=>D.value=a),type:"datetime",placeholder:"不选则使用上方发布时间或立即",style:{width:"100%"},"value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]))]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Ke=Pe(Ae,[["__scopeId","data-v-debed5b0"]]);export{Ke as default};
