import{r as c,l as ce,m as ue,n as ve,K as pe,c as L,b as M,d as n,j as E,t as N,J as g,v as z,L as fe,M as me,e as ye,q as be,g as ge,N as B,H as q}from"./index-Cc1A4YXN.js";import{V as we,u as he,c as Ve,g as ke,a as Le,d as Me,b as J}from"./VideoEditorView-DhpkzoPp.js";const Se={class:"video-library-container"},$e={class:"main-content"},_e={class:"topbar"},Te={class:"topbar-title"},Ee={key:0,class:"topbar-actions"},Ce={class:"btn",title:"上传素材（视频/音频）"},xe={class:"tabs"},Be={class:"panel"},qe={class:"row"},Re={class:"field"},Ae={class:"field"},Ie={class:"modal-header"},Oe={class:"modal-title"},De={class:"modal-body"},Ne=["src"],Fe={__name:"VideoLibrary",setup(Ge){const G=ge(),w=pe(),f=c("cloud"),S=c("videos"),R=c(""),H=c("all"),u=c([]),U=c([]),v=c({clips:[],voice:null,bgm:null,global:{speed:1}}),$=c({show:!1,message:""}),m=c({show:!1,title:"",kind:"",url:""}),K=c(null),A=c(null),y=c(null),p=c(null),Q=ce(()=>f.value==="cloud"?"云素材库":"AI视频剪辑");function r(t,a="info",o=2500){$.value={show:!0,message:t},setTimeout(()=>{$.value.show=!1},o)}function I(t,a,o){if(!o){r("预览地址无效","error");return}let i=o;if(o.startsWith("/")?i=o:!o.startsWith("http://")&&!o.startsWith("https://")&&(i="/"+o),console.log("[VideoLibrary] 打开预览模态框:",{title:t,kind:a,url:o,fullUrl:i}),m.value={show:!0,title:t,kind:a,url:i},a==="audio"){requestAnimationFrame(()=>{B(()=>{if(p.value){const e=p.value;e.src=i,e.onerror=null,e.onloadeddata=null,e.oncanplay=null,e.oncanplaythrough=null,e.onstalled=null,e.onabort=null,e.onplay=null,e.onpause=null,e.onvolumechange=null,e.onerror=l=>{var s,k;console.error("[VideoLibrary] 音频加载失败:",{error:e.error,errorCode:(s=e.error)==null?void 0:s.code,errorMessage:(k=e.error)==null?void 0:k.message,networkState:e.networkState,readyState:e.readyState,src:i,event:l});let d="音频加载失败";if(e.error)switch(e.error.code){case e.error.MEDIA_ERR_ABORTED:d="音频加载被中止";break;case e.error.MEDIA_ERR_NETWORK:d="网络错误，无法加载音频";break;case e.error.MEDIA_ERR_DECODE:d="音频解码失败";break;case e.error.MEDIA_ERR_SRC_NOT_SUPPORTED:d="音频格式不支持或文件不存在";break}r(d,"error")},e.onloadeddata=()=>{console.log("[VideoLibrary] 音频元数据加载成功:",{duration:e.duration,src:i,volume:e.volume,muted:e.muted,paused:e.paused}),e.volume=1,e.muted=!1,e.play().catch(l=>{console.log("[VideoLibrary] 自动播放需要用户交互，请手动点击播放按钮:",l.message)})},e.oncanplay=()=>{console.log("[VideoLibrary] 音频可以播放:",{src:i,volume:e.volume,muted:e.muted,paused:e.paused})},e.oncanplaythrough=()=>{console.log("[VideoLibrary] 音频可以完整播放:",i),e.volume=1,e.muted=!1},e.onstalled=()=>{console.warn("[VideoLibrary] 音频加载停滞:",i)},e.onabort=()=>{console.warn("[VideoLibrary] 音频加载被中止:",i)},e.onplay=()=>{console.log("[VideoLibrary] 音频开始播放:",i)},e.onpause=()=>{console.log("[VideoLibrary] 音频已暂停:",i)},e.onvolumechange=()=>{console.log("[VideoLibrary] 音量变化:",{volume:e.volume,muted:e.muted})},e.volume=1,e.muted=!1,console.log("[VideoLibrary] 开始加载音频:",i),e.load(),setTimeout(()=>{e.readyState>=2&&e.play().catch(l=>{console.log("[VideoLibrary] 自动播放需要用户交互，请手动点击播放按钮")})},100)}})});return}B(()=>{if(a==="video"&&y.value){const e=y.value;e.src=i,e.onerror=null,e.onloadeddata=null,e.oncanplay=null,e.onerror=l=>{console.error("[VideoLibrary] 视频加载失败:",l,e.error,i),r("视频加载失败，请检查文件是否存在","error")},e.onloadeddata=()=>{console.log("[VideoLibrary] 视频加载成功:",i)},e.oncanplay=()=>{console.log("[VideoLibrary] 视频可以播放:",i)},e.load()}})}function O(){y.value&&(y.value.pause(),y.value.src="",y.value.onerror=null),p.value&&(p.value.pause(),p.value.src="",p.value.onerror=null,p.value.onloadeddata=null),m.value.show=!1}function j(t){t.target.id==="mask"&&O()}function D(t){if(!t)return"";const a=String(t).replace(/\\/g,"/"),o=a.indexOf("uploads/");return o>=0?`/uploads/${a.slice(o+8)}`:`/uploads/${a.replace(/^\/+/,"")}`}function X(t){return t?t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(2)} KB`:t<1024*1024*1024?`${(t/(1024*1024)).toFixed(2)} MB`:`${(t/(1024*1024*1024)).toFixed(2)} GB`:"-"}function F(t){if(!t)return"-";const a=Math.floor(t/60),o=Math.floor(t%60);return`${a}:${String(o).padStart(2,"0")}`}function _(t){const a=document.createElement("div");return a.textContent=t,a.innerHTML}function T(t){f.value=t,localStorage.setItem("ve.activeView",t),t==="cloud"&&V(),t==="cloud"&&w.name==="VideoEditor"?G.replace({name:"VideoLibrary",query:{}}):t==="ai"&&w.name==="VideoLibrary"&&G.replace({name:"VideoEditor"})}function h(t){S.value=t,localStorage.setItem("ve.cloudTab",t),V()}async function Y(){var t;try{const a=await ke({type:null});a.code===200&&(u.value=Array.isArray(a.data)?a.data:((t=a.data)==null?void 0:t.materials)||[],console.log("[VideoLibrary] 加载素材成功:",{total:u.value.length,videos:u.value.filter(o=>o.type==="video").length,audios:u.value.filter(o=>o.type==="audio").length,all:u.value}))}catch(a){console.error("[VideoLibrary] 加载素材失败:",a),r(`加载素材失败：${a.message||"未知错误"}`,"error")}}async function W(){try{const t=await Le();t.code===200&&(U.value=t.data||[])}catch(t){r(`加载成品失败：${t.message||"未知错误"}`,"error")}}async function b(){await Promise.all([Y(),W()]),await B(),V()}function V(){if(!A.value)return;const t=R.value.trim().toLowerCase(),a=S.value,o=A.value;o.innerHTML="";let i=[];if(a==="videos"?i=u.value.filter(e=>e.type==="video"):a==="bgm"?(console.log("[VideoLibrary] 所有素材详情:",u.value.map(e=>({id:e.id,name:e.name,type:e.type,typeValue:typeof e.type,path:e.path}))),i=u.value.filter(e=>(e.type||"").toLowerCase()==="audio"),console.log("[VideoLibrary] BGM库筛选:",{totalMaterials:u.value.length,audioMaterials:u.value.filter(e=>(e.type||"").toLowerCase()==="audio"),filteredItems:i,allTypes:[...new Set(u.value.map(e=>(e.type||"").toLowerCase()))]})):i=U.value,t&&(i=i.filter(e=>{const l=(e.name||e.filename||"").toLowerCase(),d=(e.path||"").toLowerCase();return l.includes(t)||d.includes(t)})),!i.length){let e="暂无数据";a==="bgm"?e='暂无音频素材（BGM）<br><small style="color:#8a94a3;margin-top:8px;display:block;">请点击"上传素材"按钮上传音频文件（.mp3, .wav, .flac）</small>':a==="videos"?e='暂无视频素材<br><small style="color:#8a94a3;margin-top:8px;display:block;">请点击"上传素材"按钮上传视频文件（.mp4, .avi, .mov）</small>':a==="outputs"&&(e='暂无成品视频<br><small style="color:#8a94a3;margin-top:8px;display:block;">完成视频剪辑后，成品会显示在这里</small>'),o.innerHTML=`<div class="label" style="text-align:center;padding:40px 20px;color:#8a94a3;">${e}</div>`;return}i.forEach(e=>{const l=document.createElement("div");l.className="card",a==="outputs"?(l.innerHTML=ee(e),te(l,e)):(l.innerHTML=Z(e),ae(l,e)),o.appendChild(l)})}function Z(t){const a=t.type==="video",o=a?"video":"audio",i=a?"视频":"音频",e=a?"视频素材":"BGM素材",l=(t.path||"").split("/").pop()||"-";return`
    <div class="card-cover">
      <span class="badge ${o}">${i}</span>
      ${e}
    </div>
    <div class="card-body">
      <div class="card-title">${_(t.name||l)}</div>
      <div class="card-meta">
        <div>存储：${_(l)}</div>
        <div>上传：${_(t.created_at||t.create_time?new Date(t.created_at||t.create_time).toLocaleString():"-")}</div>
        <div>时长：<span data-meta="duration">-</span></div>
        <div>分辨率：<span data-meta="resolution">-</span></div>
      </div>
      <div class="card-actions">
        <button class="btn btn-mini" data-action="preview">预览</button>
        <a class="btn btn-mini" data-action="download" target="_blank">下载</a>
        <button class="btn btn-mini primary" data-action="add">添加到剪辑轨道</button>
        <button class="btn btn-mini danger" data-action="delete">删除</button>
      </div>
    </div>
  `}function ee(t){return`
    <div class="card-cover">
      <span class="badge output">成品</span>
      成品视频
    </div>
    <div class="card-body">
      <div class="card-title">${_(t.filename||"-")}</div>
      <div class="card-meta">
        <div>大小：${X(t.size)}</div>
        <div>更新时间：${_(t.update_time||"-")}</div>
        <div>预览：在线播放</div>
        <div></div>
      </div>
      <div class="card-actions">
        <button class="btn btn-mini" data-action="preview">预览</button>
        <button class="btn btn-mini" data-action="edit">编辑</button>
        <button class="btn btn-mini danger" data-action="delete">删除</button>
        <button class="btn btn-mini" data-action="share">分享</button>
        <a class="btn btn-mini" data-action="download" target="_blank">下载</a>
      </div>
    </div>
  `}function ae(t,a){const o=D(a.path),i=t.querySelector('[data-action="download"]'),e=t.querySelector('[data-action="preview"]'),l=t.querySelector('[data-action="add"]'),d=t.querySelector('[data-action="delete"]');i&&(i.href=o),e&&(e.onclick=()=>{I(a.name||"预览",a.type==="audio"?"audio":"video",o)}),l&&(l.onclick=()=>{a.type==="video"?(le(a.id),r("已添加到剪辑轨道")):(ne(a.id),r("已选择 BGM"))}),d&&(d.onclick=async()=>{try{await q.confirm(`确定删除素材吗？
${a.name||a.id}`,"提示",{type:"warning"});try{let s=await J(a.id,a.path,!1);s.code===200?(r("删除成功"),await b()):s.code===409?await q.confirm(`${s.message||"该素材被任务引用，确定强制删除吗？"}
强制删除会导致历史任务引用变为无效。`,"提示",{type:"warning"})&&(s=await J(a.id,a.path,!0),s.code===200&&(r("已强制删除"),await b())):r(`删除失败：${s.message||"未知错误"}`,"error")}catch(s){r(`删除异常：${s.message}`,"error")}}catch{}}),a.type==="video"&&oe(a,t),a.type==="audio"&&ie(a,t)}function te(t,a){const o=t.querySelector('[data-action="preview"]'),i=t.querySelector('[data-action="download"]'),e=t.querySelector('[data-action="delete"]'),l=t.querySelector('[data-action="edit"]'),d=t.querySelector('[data-action="share"]');o&&(o.onclick=()=>{I(a.filename||"预览","video",a.preview_url)}),i&&(i.href=a.download_url||"#"),e&&(e.onclick=async()=>{try{await q.confirm(`确定删除成品视频吗？
${a.filename}`,"提示",{type:"warning"});const s=await Me(a.filename);s.code===200?(r("删除成功"),await b()):r(`删除失败：${s.message||"未知错误"}`,"error")}catch(s){s!=="cancel"&&r(`删除异常：${s.message}`,"error")}}),l&&(l.onclick=()=>{T("ai"),r("已进入 AI 视频剪辑（后续可扩展：成品回填时间线）。")}),d&&(d.onclick=async()=>{const s=window.location.origin+(a.preview_url||"");try{await navigator.clipboard.writeText(s),r("已复制分享链接到剪贴板")}catch{r("复制失败，请手动复制预览链接","error")}})}function oe(t,a){try{const o=D(t.path),i=document.createElement("video");i.preload="metadata",i.src=o,i.onloadedmetadata=()=>{const e=a.querySelector('[data-meta="duration"]'),l=a.querySelector('[data-meta="resolution"]');e&&(e.innerText=F(i.duration)),l&&(l.innerText=`${i.videoWidth}x${i.videoHeight}`)}}catch{}}function ie(t,a){try{const o=D(t.path),i=document.createElement("audio");i.preload="metadata",i.src=o,i.onloadedmetadata=()=>{const e=a.querySelector('[data-meta="duration"]'),l=a.querySelector('[data-meta="resolution"]');e&&(e.innerText=F(i.duration)),l&&(l.innerText="-")}}catch{}}function le(t){v.value.clips||(v.value.clips=[]);const a=`${Date.now()}_${Math.random().toString(16).slice(2)}`;v.value.clips.push({id:a,materialId:t}),C()}function ne(t){v.value.bgm={materialId:t},C()}function C(){try{localStorage.setItem("ve.timeline",JSON.stringify(v.value))}catch{}}function re(t){v.value=t,C()}async function se(t){var o,i,e;const a=(o=t.target.files)==null?void 0:o[0];if(a)try{const l=a.name,d=(i=l.split(".").pop())==null?void 0:i.toLowerCase(),s=[".mp3",".wav",".flac"].includes("."+d),k=[".mp4",".avi",".mov"].includes("."+d);console.log("[VideoLibrary] 上传文件:",{fileName:l,fileExt:d,isAudio:s,isVideo:k,fileType:a.type}),r("正在上传…");const x=await he(a);if(console.log("[VideoLibrary] 上传响应:",x),x.code===200){const P=(e=x.data)==null?void 0:e.type;console.log("[VideoLibrary] 上传成功，素材类型:",P),r("上传成功，已刷新素材库"),P==="audio"&&h("bgm"),await b(),await B(),V()}else r(`上传失败：${x.message||"未知错误"}`,"error",3500)}catch(l){console.error("[VideoLibrary] 上传异常:",l),r(`上传失败：${l.message}`,"error",3500)}finally{t.target.value=""}}async function de(){try{await q.confirm("确定清空素材库吗？此操作将删除视频/音频素材文件与数据库记录。","提示",{type:"warning"});const t=await Ve();t.code===200?(r("素材库已清空"),v.value={clips:[],voice:null,bgm:null,global:{speed:1}},C(),await b()):r(`清空失败：${t.message||"未知错误"}`,"error",3500)}catch(t){t!=="cancel"&&r(`清空失败：${t.message}`,"error",3500)}}return ue(()=>w.name,t=>{if(t==="VideoEditor")T("ai");else if(t==="VideoLibrary"){const a=w.query.view;T(a==="ai"?"ai":"cloud")}},{immediate:!0}),ve(async()=>{const t=w.name==="VideoEditor",a=w.query.view;let o="cloud";(t||a==="ai")&&(o="ai");const i=localStorage.getItem("ve.cloudTab")||"videos";try{const e=localStorage.getItem("ve.timeline");e&&(v.value=JSON.parse(e))}catch{}T(o),h(i),await b(),window.addEventListener("keydown",e=>{e.key==="Escape"&&O()})}),(t,a)=>(M(),L("div",Se,[n("div",$e,[n("div",_e,[n("div",Te,N(Q.value),1),f.value==="cloud"?(M(),L("div",Ee,[n("label",Ce,[n("input",{ref_key:"uploadInput",ref:K,type:"file",style:{display:"none"},accept:".mp4,.avi,.mov,.mp3,.wav,.flac",onChange:se},null,544),a[8]||(a[8]=n("span",null,"上传素材",-1))]),n("button",{class:"btn danger",onClick:de,title:"清空素材库（视频/音频）"},[...a[9]||(a[9]=[n("span",null,"清空素材库",-1)])])])):E("",!0)]),f.value==="cloud"?(M(),L("section",{key:0,class:g(["view",{active:f.value==="cloud"}])},[n("div",xe,[n("div",{class:g(["tab",{active:S.value==="videos"}]),onClick:a[0]||(a[0]=o=>h("videos"))}," 视频素材库 ",2),n("div",{class:g(["tab",{active:S.value==="outputs"}]),onClick:a[1]||(a[1]=o=>h("outputs"))}," 成品库 ",2),n("div",{class:g(["tab",{active:S.value==="bgm"}]),onClick:a[2]||(a[2]=o=>h("bgm"))}," BGM库 ",2)]),n("div",Be,[n("div",qe,[n("div",Re,[a[10]||(a[10]=n("div",{class:"label"},"搜索（按文件名）",-1)),z(n("input",{"onUpdate:modelValue":a[3]||(a[3]=o=>R.value=o),class:"input",placeholder:"输入关键词搜索…",onInput:V},null,544),[[fe,R.value]])]),n("div",Ae,[a[12]||(a[12]=n("div",{class:"label"},"筛选（预留）",-1)),z(n("select",{"onUpdate:modelValue":a[4]||(a[4]=o=>H.value=o),class:"select",onChange:V},[...a[11]||(a[11]=[n("option",{value:"all"},"全部",-1),n("option",{value:"recent"},"最近上传/生成",-1)])],544),[[me,H.value]])])]),a[13]||(a[13]=n("div",{class:"label",style:{"margin-top":"10px"}},' 提示：点击"添加到剪辑轨道"可在 AI 模块一键生成，无需输入编号。 ',-1)),n("div",{class:"grid",ref_key:"cloudGrid",ref:A},null,512)])],2)):E("",!0),f.value==="ai"?(M(),L("section",{key:1,class:g(["view",{active:f.value==="ai"}])},[ye(we,{materials:u.value,timeline:v.value,onUpdateTimeline:re,onRefreshMaterials:b,onRefreshOutputs:W,onOpenOutputs:a[5]||(a[5]=()=>{T("cloud"),h("outputs")}),onPreviewAudio:a[6]||(a[6]=o=>I("TTS 试听","audio",o))},null,8,["materials","timeline"])],2)):E("",!0)]),n("div",{class:g(["toast",{show:$.value.show}]),ref_key:"toast",ref:$},N($.value.message),3),n("div",{class:g(["mask",{show:m.value.show}]),onClick:j},[n("div",{class:"modal",onClick:a[7]||(a[7]=be(()=>{},["stop"]))},[n("div",Ie,[n("div",Oe,N(m.value.title),1),n("button",{class:"modal-close",onClick:O},"×")]),n("div",De,[m.value.kind==="video"?(M(),L("video",{key:0,ref_key:"modalVideo",ref:y,class:"media",controls:"",src:m.value.url},null,8,Ne)):E("",!0),m.value.kind==="audio"?(M(),L("audio",{key:1,ref_key:"modalAudio",ref:p,class:"audio",controls:"",preload:"auto"},null,512)):E("",!0)])])],2)]))}};export{Fe as default};
