<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ–éŸ³ä¸­å¿ƒç®¡ç†å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .stat-card .number {
            color: #667eea;
            font-size: 32px;
            font-weight: bold;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .card h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-icon {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        
        .card p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: opacity 0.3s ease;
            text-decoration: none;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .feature-list {
            list-style: none;
            margin: 15px 0;
        }
        
        .feature-list li {
            padding: 8px 0;
            color: #666;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .feature-list li:last-child {
            border-bottom: none;
        }
        
        .feature-list li:before {
            content: "âœ“ ";
            color: #667eea;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .error {
            background: #fee;
            color: #c00;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .success {
            background: #efe;
            color: #0c0;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #loginModal.active {
            z-index: 2000;
            /* ç™»å½•æ¨¡æ€æ¡†åœ¨æœ€ä¸Šå±‚ */
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .close-btn {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .close-btn:hover {
            background: #e0e0e0;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        table th {
            background: #f5f5f5;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #ddd;
        }
        
        table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            color: #666;
        }
        
        table tr:hover {
            background: #f9f9f9;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-online {
            background: #d4edda;
            color: #155724;
        }
        
        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-logged_in {
            background: #d4edda;
            color: #155724;
        }
        
        .status-logged_out {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: none;
        }
        
        .login-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>ğŸ¬ æŠ–éŸ³ä¸­å¿ƒç®¡ç†å¹³å°</h1>
                    <p>è½»é‡çº§è®¾å¤‡ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒè¿œç¨‹ç™»å½•ã€è§†é¢‘ä¸Šä¼ å’Œå¯¹è¯åŠŸèƒ½</p>
                </div>
                <div id="userInfo" style="display: none;">
                    <span id="usernameDisplay" style="color: #666; margin-right: 15px;"></span>
                    <button class="btn btn-secondary" onclick="logout()" style="padding: 8px 16px; font-size: 13px;">ç™»å‡º</button>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>åœ¨çº¿è®¾å¤‡</h3>
                <div class="number" id="onlineDevices">-</div>
            </div>
            <div class="stat-card">
                <h3>å·²ç™»å½•è´¦å·</h3>
                <div class="number" id="loggedInAccounts">-</div>
            </div>
            <div class="stat-card">
                <h3>å¾…å¤„ç†ä»»åŠ¡</h3>
                <div class="number" id="pendingTasks">-</div>
            </div>
            <div class="stat-card">
                <h3>ç³»ç»ŸçŠ¶æ€</h3>
                <div class="number" id="systemStatus">-</div>
            </div>
        </div>

        <div class="main-grid">
            <!-- è®¾å¤‡ç®¡ç† -->
            <div class="card">
                <h2>
                    <div class="card-icon">ğŸ“±</div>
                    è®¾å¤‡ç®¡ç†
                </h2>
                <p>æŸ¥çœ‹å®¢æˆ·ç«¯è®¾å¤‡çŠ¶æ€ï¼Œè®¾å¤‡ç”±å®¢æˆ·ç«¯è‡ªåŠ¨æ³¨å†Œ</p>
                <ul class="feature-list">
                    <li>è®¾å¤‡è‡ªåŠ¨æ³¨å†Œ</li>
                    <li>åœ¨çº¿çŠ¶æ€ç›‘æ§</li>
                    <li>å¿ƒè·³æ£€æµ‹</li>
                    <li>è®¾å¤‡è¯¦æƒ…æŸ¥çœ‹</li>
                </ul>
                <button class="btn" onclick="showModal('deviceModal')">æŸ¥çœ‹è®¾å¤‡</button>
            </div>

            <!-- è´¦å·ç®¡ç† -->
            <div class="card">
                <h2>
                    <div class="card-icon">ğŸ‘¤</div>
                    è´¦å·ç®¡ç†
                </h2>
                <p>ç»‘å®šè´¦å·åˆ°å®¢æˆ·ç«¯ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯å¯¹åº”ä¸€ä¸ªè´¦å·ï¼ˆä¸€å¯¹ä¸€ï¼‰</p>
                <ul class="feature-list">
                    <li>è´¦å·ç»‘å®šï¼ˆé€šè¿‡è®¾å¤‡IDï¼‰</li>
                    <li>ç™»å½•çŠ¶æ€ç®¡ç†</li>
                    <li>ä¸€å¯¹ä¸€å…³ç³»</li>
                    <li>Cookieç®¡ç†</li>
                </ul>
                <button class="btn" onclick="openAccountModal()">ç®¡ç†è´¦å·</button>
            </div>

            <!-- è§†é¢‘ä¸Šä¼  -->
            <div class="card">
                <h2>
                    <div class="card-icon">ğŸ¥</div>
                    è§†é¢‘ä¸Šä¼ 
                </h2>
                <p>ä¸‹å‘è§†é¢‘ä¸Šä¼ ä»»åŠ¡ï¼Œè·Ÿè¸ªä¸Šä¼ è¿›åº¦</p>
                <ul class="feature-list">
                    <li>ä»»åŠ¡ä¸‹å‘</li>
                    <li>è¿›åº¦è·Ÿè¸ª</li>
                    <li>å…ƒæ•°æ®ç®¡ç†</li>
                    <li>æ‰¹é‡æ“ä½œ</li>
                </ul>
                <button class="btn" onclick="showModal('videoModal')">åˆ›å»ºä»»åŠ¡</button>
            </div>

            <!-- æ¶ˆæ¯ç®¡ç† -->
            <div class="card">
                <h2>
                    <div class="card-icon">ğŸ’¬</div>
                    æ¶ˆæ¯ç®¡ç†
                </h2>
                <p>ç›‘å¬å’Œå‘é€æ¶ˆæ¯ï¼Œç®¡ç†å¤šè´¦å·å¯¹è¯</p>
                <ul class="feature-list">
                    <li>æ¶ˆæ¯ç›‘å¬</li>
                    <li>æ¶ˆæ¯æŸ¥é˜…</li>
                    <li>æ¶ˆæ¯å‘é€</li>
                    <li>å¤šè´¦å·æ”¯æŒ</li>
                </ul>
                <button class="btn" onclick="showModal('messageModal')">ç®¡ç†æ¶ˆæ¯</button>
            </div>

        </div>
    </div>

    <!-- è®¾å¤‡ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="deviceModal">
        <div class="modal-content">
            <div class="modal-header">è®¾å¤‡ç®¡ç†</div>
            <div id="deviceMessage"></div>
            <div style="padding: 20px; text-align: center; color: #666;">
                <p style="margin-bottom: 15px;">è®¾å¤‡ç”±å®¢æˆ·ç«¯è‡ªåŠ¨æ³¨å†Œï¼Œæ— éœ€æ‰‹åŠ¨æ³¨å†Œ</p>
                <p style="font-size: 12px; color: #999;">å®¢æˆ·ç«¯å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ³¨å†Œè®¾å¤‡å¹¶å‘é€å¿ƒè·³</p>
            </div>
            <div id="deviceList" class="tab-content active">
                <div id="deviceListContent" style="min-height: 200px;">
                    <div class="loading"></div> åŠ è½½ä¸­...
                </div>
                <div class="form-actions">
                    <button class="close-btn" onclick="closeModal('deviceModal')">å…³é—­</button>
                    <button class="btn" onclick="loadDeviceList()">åˆ·æ–°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è´¦å·ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="accountModal">
        <div class="modal-content">
            <div class="modal-header">è´¦å·ç®¡ç†</div>
            <div id="accountMessage"></div>
            <div style="padding: 10px; background: #f0f7ff; border-radius: 5px; margin-bottom: 15px; font-size: 13px; color: #0066cc;">
                <strong>ğŸ’¡ æç¤ºï¼š</strong>è®¾å¤‡ç”±å®¢æˆ·ç«¯è‡ªåŠ¨æ³¨å†Œã€‚å¦‚æœå®¢æˆ·ç«¯æ˜¾ç¤º"No account found"ï¼Œè¯·åœ¨æ­¤å¤„ä¸ºè®¾å¤‡åˆ›å»ºè´¦å·ã€‚
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('accountCreate', this)">ç»‘å®šè´¦å·</button>
                <button class="tab" onclick="switchTab('accountList', this)">è´¦å·åˆ—è¡¨</button>
                <button class="tab" onclick="switchTab('accountLogin', this)">è´¦å·ç™»å½•</button>
            </div>

            <div id="accountCreate" class="tab-content active">
                <div class="form-group">
                    <label>è®¾å¤‡IDï¼ˆå­—ç¬¦ä¸²ï¼‰</label>
                    <!-- å°†åŸæ¥çš„æ–‡æœ¬è¾“å…¥æ”¹ä¸ºä¸‹æ‹‰æ¡†ï¼Œåˆ—å‡ºç°æœ‰è®¾å¤‡ -->
                    <select id="accountDeviceId">
                        <option value="">è¯·é€‰æ‹©è®¾å¤‡</option>
                    </select>
                    <small style="color: #999; display: block; margin-top: 5px;">
                        ä»å½“å‰å·²æ³¨å†Œçš„è®¾å¤‡ä¸­é€‰æ‹©ï¼ˆå®¢æˆ·ç«¯å¯åŠ¨åä¼šè‡ªåŠ¨æ³¨å†Œè®¾å¤‡ï¼‰
                    </small>
                </div>
                <div class="form-group">
                    <label>è´¦å·åç§°</label>
                    <input type="text" id="accountName" placeholder="ä¾‹å¦‚: douyin_user_001">
                </div>
                <div class="form-group">
                    <label>å¹³å°</label>
                    <select id="platform">
                        <option value="douyin">æŠ–éŸ³</option>
                        <option value="tiktok">TikTok</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button class="close-btn" onclick="closeModal('accountModal')">å…³é—­</button>
                    <button class="btn" onclick="createAccount()">ç»‘å®š</button>
                </div>
            </div>

            <div id="accountList" class="tab-content">
                <div id="accountListContent" style="min-height: 200px;">
                    <div class="loading"></div> åŠ è½½ä¸­...
                </div>
                <div class="form-actions">
                    <button class="close-btn" onclick="closeModal('accountModal')">å…³é—­</button>
                </div>
            </div>

            <div id="accountLogin" class="tab-content">
                <div class="form-group">
                    <label>è´¦å·ID</label>
                    <input type="number" id="loginAccountIdInput" placeholder="è¾“å…¥è¦ç™»å½•çš„è´¦å·ID">
                </div>
                <div id="loginStatusMessage"></div>
                
                <!-- äºŒç»´ç ç™»å½•åŒºåŸŸ -->
                <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e0e0e0;">
                    <p style="font-size: 13px; color: #666; margin-bottom: 10px; font-weight: 600;">ğŸ“± æ‰«ç ç™»å½•ï¼ˆæ¨èï¼‰</p>
                    <div class="form-actions" style="margin-bottom: 10px;">
                        <button class="btn" onclick="startAccountQrcodeLogin()" style="width: 100%;">è·å–ç™»å½•äºŒç»´ç </button>
                    </div>
                    <div id="loginQrcodeArea" style="display: none; text-align: center; margin-top: 10px;">
                        <div id="loginQrcodeLoading" class="loading" style="margin: 10px auto;"></div>
                        <img id="loginQrcodeImg" src="" alt="ç™»å½•äºŒç»´ç " style="max-width: 220px; border: 1px solid #eee; padding: 8px; border-radius: 6px; background: #fff; display: none;">
                        <p style="color: #999; font-size: 12px; margin-top: 6px;">è¯·ä½¿ç”¨æŠ–éŸ³APPæ‰«ç ç™»å½•ï¼Œç™»å½•æˆåŠŸåç³»ç»Ÿä¼šè‡ªåŠ¨æ›´æ–°è´¦å·Cookiesã€‚</p>
                    </div>
                </div>
                
                <!-- æ‰‹åŠ¨ç™»å½•åŒºåŸŸ -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee;">
                    <p style="font-size: 13px; color: #666; margin-bottom: 10px;">æˆ–ä½¿ç”¨ <strong>æ‰‹åŠ¨ç™»å½•</strong>ï¼ˆéœ€è¦æ‰‹åŠ¨ç²˜è´´Cookiesï¼‰</p>
                    <div class="form-actions">
                        <button class="close-btn" onclick="closeModal('accountModal')">å…³é—­</button>
                        <button class="btn btn-secondary" onclick="startAccountLogin()">æ‰“å¼€ç™»å½•åŠ©æ‰‹ï¼ˆæ‰‹åŠ¨ç²˜è´´Cookiesï¼‰</button>
                    </div>
                </div>
                <div id="loginProgress" style="margin-top: 20px; display: none;">
                    <p style="color: #666; font-size: 14px;">æ­£åœ¨æ‰“å¼€ç™»å½•åŠ©æ‰‹é¡µé¢...</p>
                    <div class="loading" style="margin: 10px auto;"></div>
                    <p style="color: #999; font-size: 12px; margin-top: 10px;">è¯·æŒ‰ç…§ç™»å½•åŠ©æ‰‹é¡µé¢çš„æç¤ºå®Œæˆç™»å½•æ“ä½œ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- è§†é¢‘ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div class="modal" id="videoModal">
        <div class="modal-content">
            <div class="modal-header">è§†é¢‘ä¸Šä¼ ä»»åŠ¡</div>
            <div id="videoMessage"></div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('videoCreate', this)">åˆ›å»ºä»»åŠ¡</button>
                <button class="tab" onclick="switchTab('videoList', this)">ä»»åŠ¡åˆ—è¡¨</button>
            </div>

            <div id="videoCreate" class="tab-content active">
                <div class="form-group">
                    <label>é€‰æ‹©è´¦å·ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div style="margin-bottom: 10px; display: flex; gap: 8px;">
                        <button type="button" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; flex: 1;" onclick="selectAllAccounts()">å…¨é€‰</button>
                        <button type="button" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; flex: 1;" onclick="deselectAllAccounts()">å–æ¶ˆå…¨é€‰</button>
                    </div>
                    <div id="videoAccountList" style="max-height: 200px; overflow-y: auto; overflow-x: hidden; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #fafafa;">
                        <div class="loading"></div> åŠ è½½ä¸­...
                    </div>
                    <small style="color: #999; display: block; margin-top: 5px;">å·²é€‰æ‹© <span id="selectedAccountCount">0</span> ä¸ªè´¦å·</small>
                </div>
                <div class="form-group">
                    <label>ä¸Šä¼ æ–¹å¼</label>
                    <select id="videoUploadType" onchange="toggleVideoUploadType()">
                        <option value="file">ä¸Šä¼ è§†é¢‘æ–‡ä»¶</option>
                        <option value="url">ä½¿ç”¨è§†é¢‘URL</option>
                    </select>
                </div>
                <div class="form-group" id="videoFileGroup">
                    <label>é€‰æ‹©è§†é¢‘æ–‡ä»¶</label>
                    <input type="file" id="videoFile" accept="video/*" onchange="updateVideoFileInfo()">
                    <small style="color: #999; display: block; margin-top: 5px;">æ”¯æŒå¸¸è§è§†é¢‘æ ¼å¼ï¼ˆMP4, AVI, MOVç­‰ï¼‰</small>
                    <div id="videoFileInfo" style="margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 5px; display: none;">
                        <div style="font-size: 13px; color: #666;">
                            <strong>å·²é€‰æ‹©æ–‡ä»¶ï¼š</strong><span id="videoFileName"></span><br>
                            <strong>æ–‡ä»¶å¤§å°ï¼š</strong><span id="videoFileSize"></span>
                        </div>
                    </div>
                </div>
                <div class="form-group" id="videoUrlGroup" style="display: none;">
                    <label>è§†é¢‘URL</label>
                    <input type="text" id="videoUrl" placeholder="è¾“å…¥è§†é¢‘URL">
                </div>
                <div class="form-group">
                    <label>è§†é¢‘æ ‡é¢˜</label>
                    <input type="text" id="videoTitle" placeholder="è¾“å…¥è§†é¢‘æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>è§†é¢‘æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="videoTags" placeholder="ä¾‹å¦‚: æ ‡ç­¾1,æ ‡ç­¾2">
                </div>
                <div class="form-actions">
                    <button class="close-btn" onclick="closeModal('videoModal')">å…³é—­</button>
                    <button class="btn" id="uploadVideoBtn" onclick="createVideoTask(event)">ä¸Šä¼ è§†é¢‘</button>
                </div>
            </div>

            <div id="videoList" class="tab-content">
                <div id="videoListContent" style="min-height: 200px;">
                    <div class="loading"></div> åŠ è½½ä¸­...
                </div>
                <div class="form-actions">
                    <button class="close-btn" onclick="closeModal('videoModal')">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="loginModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">ç³»ç»Ÿç™»å½•</div>
            <div id="loginMessage"></div>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="username">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="current-password" onkeypress="if(event.key==='Enter') login()">
            </div>
            <div class="form-actions">
                <button class="btn" onclick="login()" style="width: 100%;">ç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal" id="messageModal">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <div class="modal-header">æ¶ˆæ¯ç®¡ç†</div>
            <div id="messageStatusMessage"></div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('messageListen', this)">æ¶ˆæ¯ç›‘å¬</button>
                <button class="tab" onclick="switchTab('messageView', this)">æ¶ˆæ¯æŸ¥é˜…</button>
                <button class="tab" onclick="switchTab('messageSend', this)">å‘é€æ¶ˆæ¯</button>
            </div>

            <!-- æ¶ˆæ¯ç›‘å¬ -->
            <div id="messageListen" class="tab-content active">
                <div class="form-group">
                    <label>é€‰æ‹©è´¦å·</label>
                    <select id="listenAccountId" onchange="loadListenStatus()">
                        <option value="">è¯·é€‰æ‹©è´¦å·</option>
                    </select>
                </div>
                <div id="listenStatus" style="margin: 15px 0; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                    <p style="margin: 0; color: #666;">è¯·é€‰æ‹©è´¦å·å¼€å§‹ç›‘å¬</p>
                </div>
                <div style="margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label style="margin: 0; font-weight: 600; color: #333;">ç›‘å¬ä»»åŠ¡åˆ—è¡¨ï¼ˆç”¨äºè°ƒè¯•ï¼‰</label>
                        <button class="btn btn-secondary" style="padding: 5px 12px; font-size: 12px;" onclick="loadListenTasks()">åˆ·æ–°ä»»åŠ¡åˆ—è¡¨</button>
                    </div>
                    <div id="listenTasksList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #fafafa;">
                        <p style="color: #999; text-align: center; margin: 20px 0;">è¯·é€‰æ‹©è´¦å·æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨</p>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="close-btn" onclick="closeModal('messageModal')">å…³é—­</button>
                    <button class="btn" id="listenToggleBtn" onclick="toggleListen()" disabled>å¼€å§‹ç›‘å¬</button>
                </div>
            </div>

            <!-- æ¶ˆæ¯æŸ¥é˜… -->
            <div id="messageView" class="tab-content">
                <div class="form-group">
                    <label>é€‰æ‹©è´¦å·</label>
                    <select id="viewAccountId" onchange="loadMessages()">
                        <option value="">è¯·é€‰æ‹©è´¦å·</option>
                    </select>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="loadMessages()" style="margin-right: 10px;">åˆ·æ–°æ¶ˆæ¯</button>
                    <button class="btn btn-secondary" onclick="clearMessages()">æ¸…ç©ºæ¶ˆæ¯</button>
                </div>
                <div id="messagesList" style="margin-top: 15px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #fafafa;">
                    <p style="color: #999; text-align: center;">è¯·é€‰æ‹©è´¦å·æŸ¥çœ‹æ¶ˆæ¯</p>
                </div>
                <div class="form-actions" style="margin-top: 15px;">
                    <button class="close-btn" onclick="closeModal('messageModal')">å…³é—­</button>
                </div>
            </div>

            <!-- å‘é€æ¶ˆæ¯ -->
            <div id="messageSend" class="tab-content">
                <div class="form-group">
                    <label>é€‰æ‹©è´¦å·</label>
                    <select id="sendAccountId">
                        <option value="">è¯·é€‰æ‹©è´¦å·</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç›®æ ‡ç”¨æˆ·</label>
                    <input type="text" id="sendTargetUser" placeholder="è¾“å…¥ç›®æ ‡ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label>æ¶ˆæ¯å†…å®¹</label>
                    <textarea id="sendMessageText" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹" rows="4"></textarea>
                </div>
                <div id="sendStatusMessage"></div>
                <div class="form-actions">
                    <button class="close-btn" onclick="closeModal('messageModal')">å…³é—­</button>
                    <button class="btn" onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è‡ªåŠ¨æ£€æµ‹APIåœ°å€ï¼ˆæ ¹æ®å½“å‰è®¿é—®çš„åŸŸåï¼‰
        const API_BASE = window.location.origin + '/api';
        let isLoggedIn = false;
        let statsInterval = null; // ç»Ÿè®¡åˆ·æ–°å®šæ—¶å™¨

        // åˆå§‹åŒ–
        function init() {
            checkLoginStatus();
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            fetch(`${API_BASE}/auth/check`, {
                    credentials: 'include' // åŒ…å«cookie
                })
                .then(r => r.json())
                .then(res => {
                    if (res.code === 200) {
                        if (res.data.logged_in) {
                            isLoggedIn = true;
                            document.getElementById('loginModal').classList.remove('active');
                            document.getElementById('userInfo').style.display = 'block';
                            document.getElementById('usernameDisplay').textContent = `æ¬¢è¿ï¼Œ${res.data.username}`;
                            // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
                            loadStats();
                            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                            if (statsInterval) {
                                clearInterval(statsInterval);
                            }
                            statsInterval = setInterval(loadStats, 5000); // æ¯5ç§’åˆ·æ–°ç»Ÿè®¡
                        } else {
                            isLoggedIn = false;
                            document.getElementById('loginModal').classList.add('active');
                            document.getElementById('userInfo').style.display = 'none';
                        }
                    }
                })
                .catch(e => {
                    console.error('Check login status error:', e);
                    // å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œæ˜¾ç¤ºç™»å½•æ¡†
                    document.getElementById('loginModal').classList.add('active');
                });
        }

        // ç™»å½•
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showMessage('loginMessage', 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // åŒ…å«cookie
                    body: JSON.stringify({
                        username,
                        password
                    })
                })
                .then(r => r.json())
                .then(res => {
                    if (res.code === 200) {
                        isLoggedIn = true;
                        document.getElementById('loginModal').classList.remove('active');
                        document.getElementById('userInfo').style.display = 'block';
                        document.getElementById('usernameDisplay').textContent = `æ¬¢è¿ï¼Œ${res.data.username}`;
                        document.getElementById('loginUsername').value = '';
                        document.getElementById('loginPassword').value = '';
                        // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
                        loadStats();
                        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (statsInterval) {
                            clearInterval(statsInterval);
                        }
                        statsInterval = setInterval(loadStats, 5000); // æ¯5ç§’åˆ·æ–°ç»Ÿè®¡
                    } else {
                        showMessage('loginMessage', res.message || 'ç™»å½•å¤±è´¥', 'error');
                    }
                })
                .catch(e => {
                    showMessage('loginMessage', 'ç™»å½•å¤±è´¥: ' + e.message, 'error');
                });
        }

        // ç™»å‡º
        function logout() {
            if (confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                fetch(`${API_BASE}/auth/logout`, {
                        method: 'POST',
                        credentials: 'include' // åŒ…å«cookie
                    })
                    .then(r => r.json())
                    .then(res => {
                        isLoggedIn = false;
                        document.getElementById('loginModal').classList.add('active');
                        document.getElementById('userInfo').style.display = 'none';
                        // æ¸…é™¤å®šæ—¶å™¨
                        if (statsInterval) {
                            clearInterval(statsInterval);
                            statsInterval = null;
                        }
                        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
                        document.getElementById('onlineDevices').textContent = '-';
                        document.getElementById('loggedInAccounts').textContent = '-';
                        document.getElementById('pendingTasks').textContent = '-';
                        document.getElementById('systemStatus').textContent = '-';
                    })
                    .catch(e => {
                        console.error('Logout error:', e);
                    });
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        function loadStats() {
            fetch(`${API_BASE}/stats`)
                .then(r => r.json())
                .then(res => {
                    if (res.code === 200) {
                        document.getElementById('onlineDevices').textContent = res.data.online_devices;
                        document.getElementById('loggedInAccounts').textContent = res.data.logged_in_accounts;
                        const pending = res.data.pending_video_tasks + res.data.pending_chat_tasks;
                        document.getElementById('pendingTasks').textContent = pending;
                        document.getElementById('systemStatus').textContent = 'æ­£å¸¸';
                    }
                })
                .catch(e => {
                    document.getElementById('systemStatus').textContent = 'ç¦»çº¿';
                    console.error('Stats error:', e);
                });
        }

        // è®¾å¤‡åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°
        let deviceListRefreshInterval = null;

        // æ¨¡æ€æ¡†æ§åˆ¶
        function showModal(id) {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                document.getElementById('loginModal').classList.add('active');
                return;
            }
            document.getElementById(id).classList.add('active');

            // åŠ è½½åˆ—è¡¨æ•°æ®
            if (id === 'deviceModal') {
                loadDeviceList();
                // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯5ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰
                startDeviceListAutoRefresh();
            } else {
                // åˆ‡æ¢åˆ°å…¶ä»–æ¨¡æ€æ¡†æ—¶ï¼Œåœæ­¢è®¾å¤‡åˆ—è¡¨åˆ·æ–°
                if (deviceListRefreshInterval) {
                    clearInterval(deviceListRefreshInterval);
                    deviceListRefreshInterval = null;
                }
            }

            if (id === 'accountModal') {
                loadAccountList();
                // æ³¨æ„ï¼šloadAccountDeviceOptions ä¼šåœ¨ openAccountModal() ä¸­è°ƒç”¨ï¼Œé¿å…é‡å¤è°ƒç”¨
                // å¦‚æœç›´æ¥è°ƒç”¨ showModal('accountModal')ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨è°ƒç”¨ loadAccountDeviceOptions()
                if (!document.getElementById('accountDeviceId').options.length || document.getElementById('accountDeviceId').options.length === 1) {
                    loadAccountDeviceOptions(); // åªåœ¨æœªåŠ è½½æ—¶åŠ è½½è®¾å¤‡ä¸‹æ‹‰åˆ—è¡¨
                }
            } else if (id === 'videoModal') {
                loadVideoList();
                loadVideoAccountList();
            } else if (id === 'messageModal') {
                loadAccountOptions();
                loadListenStatus();
            }
        }

        function startDeviceListAutoRefresh() {
            // æ¸…é™¤ä¹‹å‰çš„åˆ·æ–°
            if (deviceListRefreshInterval) {
                clearInterval(deviceListRefreshInterval);
            }

            // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡è®¾å¤‡åˆ—è¡¨
            deviceListRefreshInterval = setInterval(() => {
                // æ£€æŸ¥è®¾å¤‡æ¨¡æ€æ¡†æ˜¯å¦ä»ç„¶æ‰“å¼€
                if (document.getElementById('deviceModal').classList.contains('active')) {
                    loadDeviceList();
                } else {
                    // å¦‚æœæ¨¡æ€æ¡†å·²å…³é—­ï¼Œåœæ­¢åˆ·æ–°
                    clearInterval(deviceListRefreshInterval);
                    deviceListRefreshInterval = null;
                }
            }, 5000);
        }

        function closeModal(id) {
            // å¦‚æœæ˜¯ç™»å½•æ¨¡æ€æ¡†ä¸”æœªç™»å½•ï¼Œä¸å…è®¸å…³é—­
            if (id === 'loginModal' && !isLoggedIn) {
                return;
            }
            document.getElementById(id).classList.remove('active');

            // å¦‚æœå…³é—­è®¾å¤‡æ¨¡æ€æ¡†ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°
            if (id === 'deviceModal' && deviceListRefreshInterval) {
                clearInterval(deviceListRefreshInterval);
                deviceListRefreshInterval = null;
            }
        }

        function switchTab(tabId, btn) {
            // éšè—æ‰€æœ‰tabå†…å®¹
            const contents = btn.parentElement.parentElement.querySelectorAll('.tab-content');
            contents.forEach(c => c.classList.remove('active'));

            // ç§»é™¤æ‰€æœ‰tabçš„activeç±»
            const tabs = btn.parentElement.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));

            // æ˜¾ç¤ºå½“å‰tab
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');

            // å¦‚æœåˆ‡æ¢åˆ°ä»»åŠ¡åˆ—è¡¨ï¼ŒåŠ è½½å¹¶å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
            if (tabId === 'videoList') {
                loadVideoList();
                startVideoListAutoRefresh();
            } else {
                // åˆ‡æ¢åˆ°å…¶ä»–tabæ—¶ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°
                if (videoListRefreshInterval) {
                    clearInterval(videoListRefreshInterval);
                    videoListRefreshInterval = null;
                }
            }
        }

        // ä»»åŠ¡åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°
        let videoListRefreshInterval = null;

        function startVideoListAutoRefresh() {
            // æ¸…é™¤ä¹‹å‰çš„åˆ·æ–°
            if (videoListRefreshInterval) {
                clearInterval(videoListRefreshInterval);
            }

            // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡ä»»åŠ¡åˆ—è¡¨
            videoListRefreshInterval = setInterval(() => {
                // æ£€æŸ¥ä»»åŠ¡åˆ—è¡¨æ ‡ç­¾é¡µæ˜¯å¦ä»ç„¶æ¿€æ´»
                if (document.getElementById('videoList').classList.contains('active')) {
                    loadVideoList();
                } else {
                    // å¦‚æœæ ‡ç­¾é¡µä¸æ¿€æ´»ï¼Œåœæ­¢åˆ·æ–°
                    clearInterval(videoListRefreshInterval);
                    videoListRefreshInterval = null;
                }
            }, 3000);
        }

        // è®¾å¤‡ç®¡ç†ï¼ˆè®¾å¤‡ç”±å®¢æˆ·ç«¯è‡ªåŠ¨æ³¨å†Œï¼Œè¿™é‡Œåªæ˜¾ç¤ºåˆ—è¡¨ï¼‰

        function loadDeviceList() {
            // åŒæ—¶åŠ è½½è®¾å¤‡å’Œè´¦å·ä¿¡æ¯
            Promise.all([
                    fetch(`${API_BASE}/devices`).then(r => r.json()),
                    fetch(`${API_BASE}/accounts`).then(r => r.json())
                ])
                .then(([devicesRes, accountsRes]) => {
                        if (devicesRes.code === 200 && accountsRes.code === 200) {
                            const devices = devicesRes.data || [];
                            const accounts = accountsRes.data || [];

                            // åˆ›å»ºè´¦å·æ˜ å°„ï¼ˆdevice_id -> accountï¼‰
                            const accountMap = {};
                            accounts.forEach(acc => {
                                // é€šè¿‡device_idï¼ˆæ•°æ®åº“idï¼‰æŸ¥æ‰¾å¯¹åº”çš„è®¾å¤‡å­—ç¬¦ä¸²ID
                                const device = devices.find(d => d.id === acc.device_id);
                                if (device) {
                                    accountMap[device.device_id] = acc;
                                }
                            });

                            const html = devices.length ? `
                            <table>
                                <tr>
                                    <th>ID</th>
                                    <th>è®¾å¤‡ID</th>
                                    <th>è®¾å¤‡åç§°</th>
                                    <th>IPåœ°å€</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æœ€åå¿ƒè·³</th>
                                    <th>å…³è”è´¦å·</th>
                                </tr>
                                ${devices.map(d => {
                                    const account = accountMap[d.device_id];
                                    return `
                                    <tr>
                                        <td>${d.id}</td>
                                        <td><code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${d.device_id}</code></td>
                                        <td>${d.device_name || '-'}</td>
                                        <td>${d.ip_address || '-'}</td>
                                        <td><span class="status-badge status-${d.status}">${d.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}</span></td>
                                        <td>${d.last_heartbeat ? (() => {
                                            try {
                                                // å¤„ç†SQLiteæ—¶é—´æ ¼å¼ (YYYY-MM-DD HH:MM:SS)
                                                const timeStr = d.last_heartbeat.replace(' ', 'T');
                                                const date = new Date(timeStr);
                                                return date.toLocaleString('zh-CN', {hour12: false});
                                            } catch(e) {
                                                return d.last_heartbeat;
                                            }
                                        })() : '<span style="color: #999;">ä»æœªå¿ƒè·³</span>'}</td>
                                        <td>
                                            ${account ? 
                                                `${account.account_name} (è´¦å·ID: ${account.id})` : 
                                                `<button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="createAccountForDevice('${d.device_id}')">åˆ›å»ºè´¦å·</button>`
                                            }
                                        </td>
                                    </tr>
                                `;
                                }).join('')}
                            </table>
                        ` : '<p style="color: #999;">æš‚æ— è®¾å¤‡ï¼ˆè®¾å¤‡ç”±å®¢æˆ·ç«¯è‡ªåŠ¨æ³¨å†Œï¼‰</p>';
                        document.getElementById('deviceListContent').innerHTML = html;
                    }
                })
                .catch(e => {
                    console.error('Load devices error:', e);
                    document.getElementById('deviceListContent').innerHTML = '<p style="color: #c00;">åŠ è½½å¤±è´¥</p>';
                });
        }
        
        // è´¦å·ç™»å½•
        function startAccountLogin() {
            const accountId = parseInt(document.getElementById('loginAccountIdInput').value);
            if (!accountId) {
                showMessage('loginStatusMessage', 'è¯·è¾“å…¥è´¦å·ID', 'error');
                return;
            }
            startAccountLoginById(accountId);
        }
        
        // æ‰«ç ç™»å½•ï¼šè·å–æŠ–éŸ³åˆ›ä½œè€…ä¸­å¿ƒäºŒç»´ç 
        function startAccountQrcodeLogin() {
            const accountId = parseInt(document.getElementById('loginAccountIdInput').value);
            if (!accountId) {
                showMessage('loginStatusMessage', 'è¯·è¾“å…¥è´¦å·ID', 'error');
                return;
            }

            const qrcodeArea = document.getElementById('loginQrcodeArea');
            const qrcodeImg = document.getElementById('loginQrcodeImg');
            const qrcodeLoading = document.getElementById('loginQrcodeLoading');

            qrcodeArea.style.display = 'block';
            qrcodeImg.style.display = 'none';
            qrcodeLoading.style.display = 'block';

            showMessage('loginStatusMessage', 'æ­£åœ¨è·å–ç™»å½•äºŒç»´ç ...', 'info');

            fetch(`${API_BASE}/login/qrcode?account_id=${accountId}`, {
                method: 'GET',
                credentials: 'include',
                timeout: 60000  // 60ç§’è¶…æ—¶ï¼ˆPlaywrightå¯åŠ¨æµè§ˆå™¨éœ€è¦æ—¶é—´ï¼‰
            })
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                    }
                    return r.json();
                })
                .then(res => {
                    if (res.code === 200 && res.data && res.data.qrcode) {
                        qrcodeImg.src = res.data.qrcode;
                        qrcodeImg.style.display = 'inline-block';
                        qrcodeLoading.style.display = 'none';
                        showMessage('loginStatusMessage', 'äºŒç»´ç å·²ç”Ÿæˆï¼Œè¯·ä½¿ç”¨æŠ–éŸ³APPæ‰«ç ç™»å½•ã€‚ç³»ç»Ÿæ­£åœ¨åå°ç­‰å¾…ç™»å½•å®Œæˆ...', 'success');
                        
                        // å¼€å§‹è½®è¯¢ç™»å½•çŠ¶æ€
                        pollQrcodeLoginStatus(accountId);
                    } else {
                        qrcodeLoading.style.display = 'none';
                        showMessage('loginStatusMessage', res.message || 'è·å–äºŒç»´ç å¤±è´¥', 'error');
                    }
                })
                .catch(e => {
                    qrcodeLoading.style.display = 'none';
                    console.error('Get QR code error:', e);
                    let errorMsg = 'è·å–äºŒç»´ç å¤±è´¥: ' + e.message;
                    if (e.message.includes('ERR_CONNECTION_RESET') || e.message.includes('Failed to fetch')) {
                        errorMsg = 'è¿æ¥è¢«é‡ç½®ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨å¤„ç†è¶…æ—¶ã€‚è¯·æ£€æŸ¥ï¼š1) Playwrightæ˜¯å¦å·²å®‰è£… 2) Chromeæµè§ˆå™¨æ˜¯å¦å¯ç”¨ 3) ç¨åé‡è¯•';
                    }
                    showMessage('loginStatusMessage', errorMsg, 'error');
                });
        
        // è½®è¯¢äºŒç»´ç ç™»å½•çŠ¶æ€
        function pollQrcodeLoginStatus(accountId) {
            const maxAttempts = 300; // æœ€å¤šè½®è¯¢5åˆ†é’Ÿï¼ˆæ¯1ç§’ä¸€æ¬¡ï¼‰
            let attempts = 0;
            
            const checkStatus = () => {
                attempts++;
                if (attempts > maxAttempts) {
                    // ç™»å½•è¶…æ—¶ï¼šå…³é—­äºŒç»´ç å¹¶æ˜¾ç¤ºé”™è¯¯æç¤º
                    const qrcodeArea = document.getElementById('loginQrcodeArea');
                    if (qrcodeArea) {
                        qrcodeArea.style.display = 'none';
                    }
                    showMessage('loginStatusMessage', 'ç™»å½•è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰ï¼Œè¯·é‡æ–°è·å–äºŒç»´ç é‡è¯•', 'error');
                    return;
                }
                
                fetch(`${API_BASE}/accounts/${accountId}`)
                    .then(r => {
                        if (!r.ok) {
                            throw new Error(`HTTP ${r.status}`);
                        }
                        return r.json();
                    })
                    .then(res => {
                        if (res.code === 200) {
                            const account = res.data;
                            if (account.login_status === 'logged_in' && account.cookies) {
                                // ç™»å½•æˆåŠŸï¼šæ˜¾ç¤ºæç¤ºå¹¶å…³é—­äºŒç»´ç 
                                const qrcodeArea = document.getElementById('loginQrcodeArea');
                                const qrcodeImg = document.getElementById('loginQrcodeImg');
                                
                                // å…³é—­äºŒç»´ç æ˜¾ç¤ºåŒºåŸŸ
                                if (qrcodeArea) {
                                    qrcodeArea.style.display = 'none';
                                }
                                if (qrcodeImg) {
                                    qrcodeImg.src = ''; // æ¸…ç©ºäºŒç»´ç 
                                    qrcodeImg.style.display = 'none';
                                }
                                
                                // æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆæ›´æ˜æ˜¾ï¼‰
                                showMessage('loginStatusMessage', 'âœ… ç™»å½•æˆåŠŸï¼Cookieså·²è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ï¼Œè´¦å·å·²å¯ç”¨', 'success');
                                
                                // åˆ·æ–°è´¦å·åˆ—è¡¨å’Œç»Ÿè®¡
                                loadAccountList();
                                loadStats();
                                
                                // 3ç§’åæ¸…ç©ºè´¦å·IDè¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ç™»å½•
                                setTimeout(() => {
                                    const accountIdInput = document.getElementById('loginAccountIdInput');
                                    if (accountIdInput) {
                                        accountIdInput.value = '';
                                    }
                                }, 3000);
                            } else {
                                // ä»åœ¨ç­‰å¾…ç™»å½•ï¼Œç»§ç»­è½®è¯¢
                                setTimeout(checkStatus, 1000);
                            }
                        } else {
                            setTimeout(checkStatus, 1000);
                        }
                    })
                    .catch(e => {
                        console.error('Poll QR code login status error:', e);
                        setTimeout(checkStatus, 1000);
                    });
            };
            
            checkStatus();
        }
        }
        
        function startAccountLoginById(accountId) {
            showMessage('loginStatusMessage', 'æ­£åœ¨æ‰“å¼€ç™»å½•åŠ©æ‰‹é¡µé¢...', 'success');
            document.getElementById('loginProgress').style.display = 'block';
            
            fetch(`${API_BASE}/login/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ account_id: accountId })
            })
            .then(r => {
                if (!r.ok) {
                    throw new Error(`HTTP ${r.status}`);
                }
                return r.json();
            })
            .then(res => {
                if (res.code === 200) {
                    // æ‰“å¼€ç™»å½•åŠ©æ‰‹é¡µé¢
                    const loginUrl = window.location.origin + res.data.login_url;
                    const loginWindow = window.open(loginUrl, '_blank', 'width=800,height=900');
                    
                    if (loginWindow) {
                        showMessage('loginStatusMessage', 'ç™»å½•åŠ©æ‰‹é¡µé¢å·²æ‰“å¼€ï¼Œè¯·æŒ‰ç…§é¡µé¢æç¤ºå®Œæˆç™»å½•', 'success');
                        // ç›‘å¬ç™»å½•æˆåŠŸæ¶ˆæ¯
                        window.addEventListener('message', function(event) {
                            if (event.data && event.data.type === 'login_success' && event.data.account_id === accountId) {
                                showMessage('loginStatusMessage', 'ç™»å½•æˆåŠŸï¼Cookieså·²ä¿å­˜åˆ°æ•°æ®åº“', 'success');
                                document.getElementById('loginProgress').style.display = 'none';
                                loadAccountList();
                                loadStats();
                                // ç§»é™¤ç›‘å¬å™¨
                                window.removeEventListener('message', arguments.callee);
                            }
                        });
                        // å¼€å§‹è½®è¯¢ç™»å½•çŠ¶æ€ï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
                        pollLoginStatus(accountId);
                    } else {
                        showMessage('loginStatusMessage', 'æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®', 'error');
                        document.getElementById('loginProgress').style.display = 'none';
                    }
                } else {
                    showMessage('loginStatusMessage', res.message, 'error');
                    document.getElementById('loginProgress').style.display = 'none';
                }
            })
            .catch(e => {
                showMessage('loginStatusMessage', 'è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
                document.getElementById('loginProgress').style.display = 'none';
            });
        }
        
        function pollLoginStatus(accountId) {
            const maxAttempts = 300; // æœ€å¤šè½®è¯¢5åˆ†é’Ÿï¼ˆæ¯1ç§’ä¸€æ¬¡ï¼‰
            let attempts = 0;
            let lastStatus = null;
            
            const checkStatus = () => {
                attempts++;
                if (attempts > maxAttempts) {
                    showMessage('loginStatusMessage', 'ç™»å½•è¶…æ—¶ï¼Œè¯·é‡è¯•', 'error');
                    document.getElementById('loginProgress').style.display = 'none';
                    return;
                }
                
                fetch(`${API_BASE}/accounts/${accountId}`)
                    .then(r => {
                        if (!r.ok) {
                            throw new Error(`HTTP ${r.status}`);
                        }
                        return r.json();
                    })
                    .then(res => {
                        if (res.code === 200) {
                            const account = res.data;
                            // å¦‚æœçŠ¶æ€ä»æœªç™»å½•å˜ä¸ºå·²ç™»å½•ï¼Œè¯´æ˜ç™»å½•æˆåŠŸ
                            if (lastStatus === 'logged_out' && account.login_status === 'logged_in') {
                                showMessage('loginStatusMessage', 'ç™»å½•æˆåŠŸï¼Cookieså·²ä¿å­˜åˆ°æ•°æ®åº“', 'success');
                                document.getElementById('loginProgress').style.display = 'none';
                                loadAccountList();
                                loadStats();
                            } else if (account.login_status === 'logged_in' && account.cookies) {
                                // å¦‚æœå·²ç»æœ‰cookiesï¼Œè¯´æ˜ç™»å½•æˆåŠŸ
                                showMessage('loginStatusMessage', 'ç™»å½•æˆåŠŸï¼Cookieså·²ä¿å­˜åˆ°æ•°æ®åº“', 'success');
                                document.getElementById('loginProgress').style.display = 'none';
                                loadAccountList();
                                loadStats();
                            } else {
                                // ä»åœ¨è¿›è¡Œä¸­ï¼Œç»§ç»­è½®è¯¢
                                lastStatus = account.login_status;
                                setTimeout(checkStatus, 1000);
                            }
                        } else {
                            setTimeout(checkStatus, 1000);
                        }
                    })
                    .catch(e => {
                        console.error('Poll login status error:', e);
                        setTimeout(checkStatus, 1000);
                    });
            };
            
            checkStatus();
        }
        
        // æ‰“å¼€è´¦å·ç®¡ç†å¼¹çª—ï¼ˆåŒæ—¶åŠ è½½è®¾å¤‡ä¸‹æ‹‰åˆ—è¡¨ï¼‰
        function openAccountModal() {
            showModal('accountModal');
            loadAccountDeviceOptions();
        }

        // åŠ è½½è´¦å·ç»‘å®šç”¨çš„è®¾å¤‡ä¸‹æ‹‰åˆ—è¡¨
        function loadAccountDeviceOptions(selectedDeviceId = null) {
            const select = document.getElementById('accountDeviceId');
            if (!select) return;

            // å…ˆæ¸…ç©ºï¼ŒåŠ å…¥å ä½é¡¹
            select.innerHTML = '<option value=\"\">è¯·é€‰æ‹©è®¾å¤‡</option>';

            fetch(`${API_BASE}/devices`)
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP ${r.status}`);
                    }
                    return r.json();
                })
                .then(res => {
                    if (res.code !== 200) return;
                    const devices = res.data || [];

                    // å»é‡ï¼šä½¿ç”¨Mapè®°å½•å·²æ·»åŠ çš„device_idï¼Œé¿å…é‡å¤
                    const deviceMap = new Map();
                    devices.forEach(d => {
                        if (d.device_id && !deviceMap.has(d.device_id)) {
                            deviceMap.set(d.device_id, d);
                        }
                    });

                    // åªå±•ç¤ºå·²æ³¨å†Œçš„è®¾å¤‡ï¼ˆå…¨éƒ¨åˆ—å‡ºï¼Œç¦»çº¿è®¾å¤‡ä¹Ÿå¯ä»¥é€‰ï¼‰
                    deviceMap.forEach((d, deviceId) => {
                        const option = document.createElement('option');
                        option.value = deviceId;
                        const statusText = d.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';
                        option.textContent = `${deviceId}  (${d.device_name || 'æœªå‘½å'} / ${statusText})`;
                        select.appendChild(option);
                    });

                    // å¦‚æœä¼ å…¥äº†é¢„é€‰ä¸­çš„device_idï¼Œåˆ™é€‰ä¸­å®ƒ
                    if (selectedDeviceId) {
                        select.value = selectedDeviceId;
                    }
                })
                .catch((e) => {
                    console.error('Failed to load devices:', e);
                    // ç½‘ç»œé”™è¯¯æ—¶ä¿æŒä¸ºå¯æ‰‹åŠ¨è¾“å…¥çš„ä¸‹æ‹‰ï¼ˆç”¨æˆ·ä»å¯è‡ªå·±é”®å…¥ï¼‰
                });
        }

        // è´¦å·ç®¡ç†
        function createAccount(deviceId = null) {
            const data = {
                device_id: deviceId || document.getElementById('accountDeviceId').value.trim(), // è®¾å¤‡çš„å­—ç¬¦ä¸²ID
                account_name: document.getElementById('accountName').value.trim(),
                platform: document.getElementById('platform').value
            };
            
            if (!data.device_id || !data.account_name) {
                showMessage('accountMessage', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
                return;
            }
            
            fetch(`${API_BASE}/accounts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(res => {
                if (res.code === 201) {
                    showMessage('accountMessage', 'è´¦å·ç»‘å®šæˆåŠŸ', 'success');
                    document.getElementById('accountDeviceId').value = '';
                    document.getElementById('accountName').value = '';
                    loadAccountList();
                    loadDeviceList(); // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
                    loadStats();
                } else {
                    showMessage('accountMessage', res.message, 'error');
                }
            })
            .catch(e => showMessage('accountMessage', 'è¯·æ±‚å¤±è´¥: ' + e.message, 'error'));
        }
        
        // ä¸ºè®¾å¤‡åˆ›å»ºè´¦å·ï¼ˆä»è®¾å¤‡åˆ—è¡¨è°ƒç”¨ï¼‰
        function createAccountForDevice(deviceId) {
            // æ‰“å¼€è´¦å·ç®¡ç†æ¨¡æ€æ¡†ï¼ˆåŒæ—¶åˆ·æ–°è®¾å¤‡ä¸‹æ‹‰ï¼‰
            openAccountModal();
            // åˆ‡æ¢åˆ°åˆ›å»ºè´¦å·æ ‡ç­¾é¡µ
            const createTab = document.querySelector('#accountModal .tab');
            if (createTab) {
                switchTab('accountCreate', createTab);
            }
            // ç­‰å¾…è®¾å¤‡åˆ—è¡¨åŠ è½½å®Œæˆåå†è®¾ç½®é€‰ä¸­å€¼
            setTimeout(() => {
                loadAccountDeviceOptions(deviceId); // é‡æ–°åŠ è½½å¹¶é€‰ä¸­æŒ‡å®šè®¾å¤‡
                // èšç„¦åˆ°è´¦å·åç§°è¾“å…¥æ¡†
                setTimeout(() => {
                    document.getElementById('accountName').focus();
                }, 100);
            }, 200);
        }
        
        function loadAccountList() {
            // åŒæ—¶åŠ è½½è´¦å·å’Œè®¾å¤‡ä¿¡æ¯
            Promise.all([
                fetch(`${API_BASE}/accounts`).then(r => r.json()),
                fetch(`${API_BASE}/devices`).then(r => r.json())
            ])
                .then(([accountsRes, devicesRes]) => {
                    if (accountsRes.code === 200 && devicesRes.code === 200) {
                        const accounts = accountsRes.data || [];
                        const devices = devicesRes.data || [];
                        
                        // åˆ›å»ºè®¾å¤‡æ˜ å°„ï¼ˆæ•°æ®åº“id -> è®¾å¤‡å­—ç¬¦ä¸²IDï¼‰
                        const deviceMap = {};
                        devices.forEach(d => {
                            deviceMap[d.id] = d.device_id;
                        });
                        
                        const html = accounts.length ? `
                            <table>
                                <tr>
                                    <th>ID</th>
                                    <th>è®¾å¤‡ID</th>
                                    <th>è´¦å·åç§°</th>
                                    <th>å¹³å°</th>
                                    <th>ç™»å½•çŠ¶æ€</th>
                                    <th>æœ€åç™»å½•</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                                ${accounts.map(a => {
                                    const deviceIdStr = deviceMap[a.device_id] || a.device_id;
                                    // è½¬ä¹‰è´¦å·åç§°ä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢XSS
                                    const accountNameEscaped = (a.account_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                    return `
                                    <tr>
                                        <td>${a.id}</td>
                                        <td><code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${deviceIdStr}</code></td>
                                        <td>${a.account_name}</td>
                                        <td>${a.platform}</td>
                                        <td><span class="status-badge status-${a.login_status}">${a.login_status}</span></td>
                                        <td>${a.last_login_time ? new Date(a.last_login_time).toLocaleString('zh-CN') : '-'}</td>
                                        <td>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="startAccountLoginById(${a.id})">
                                                    ${a.login_status === 'logged_in' ? 'é‡æ–°ç™»å½•' : 'ç™»å½•'}
                                                </button>
                                                <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px; background: #f8d7da; color: #721c24;" onclick="deleteAccount(${a.id}, '${accountNameEscaped}')">
                                                    åˆ é™¤
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                                }).join('')}
                            </table>
                        ` : '<p style="color: #999;">æš‚æ— è´¦å·</p>';
                        document.getElementById('accountListContent').innerHTML = html;
                    }
                })
                .catch(e => {
                    console.error('Load accounts error:', e);
                    document.getElementById('accountListContent').innerHTML = '<p style="color: #c00;">åŠ è½½å¤±è´¥</p>';
                });
        }
        
        // åˆ é™¤è´¦å·
        function deleteAccount(accountId, accountName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è´¦å· "${accountName}" (ID: ${accountId}) å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤ï¼š\n- è´¦å·ä¿¡æ¯\n- ç›¸å…³æ¶ˆæ¯è®°å½•\n- ç›¸å…³è§†é¢‘ä»»åŠ¡\n- ç›¸å…³å¯¹è¯ä»»åŠ¡\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            fetch(`${API_BASE}/accounts/${accountId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(r => r.json())
            .then(res => {
                if (res.code === 200) {
                    showMessage('accountMessage', `è´¦å· "${accountName}" å·²æˆåŠŸåˆ é™¤`, 'success');
                    loadAccountList();
                    loadDeviceList(); // åˆ·æ–°è®¾å¤‡åˆ—è¡¨ï¼ˆå› ä¸ºè®¾å¤‡åˆ—è¡¨ä¹Ÿæ˜¾ç¤ºè´¦å·ä¿¡æ¯ï¼‰
                    loadStats(); // åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
                } else {
                    showMessage('accountMessage', res.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            })
            .catch(e => {
                showMessage('accountMessage', 'åˆ é™¤å¤±è´¥: ' + e.message, 'error');
            });
        }
        
        // åˆ‡æ¢è§†é¢‘ä¸Šä¼ æ–¹å¼
        function toggleVideoUploadType() {
            const uploadType = document.getElementById('videoUploadType').value;
            const fileGroup = document.getElementById('videoFileGroup');
            const urlGroup = document.getElementById('videoUrlGroup');
            
            if (uploadType === 'file') {
                fileGroup.style.display = 'block';
                urlGroup.style.display = 'none';
            } else {
                fileGroup.style.display = 'none';
                urlGroup.style.display = 'block';
            }
        }
        
        // æ›´æ–°è§†é¢‘æ–‡ä»¶ä¿¡æ¯
        function updateVideoFileInfo() {
            const fileInput = document.getElementById('videoFile');
            const fileInfo = document.getElementById('videoFileInfo');
            const fileName = document.getElementById('videoFileName');
            const fileSize = document.getElementById('videoFileSize');
            
            if (fileInput.files && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileName.textContent = file.name;
                
                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                let size = file.size;
                let sizeUnit = 'B';
                if (size >= 1024 * 1024 * 1024) {
                    size = (size / (1024 * 1024 * 1024)).toFixed(2);
                    sizeUnit = 'GB';
                } else if (size >= 1024 * 1024) {
                    size = (size / (1024 * 1024)).toFixed(2);
                    sizeUnit = 'MB';
                } else if (size >= 1024) {
                    size = (size / 1024).toFixed(2);
                    sizeUnit = 'KB';
                }
                fileSize.textContent = size + ' ' + sizeUnit;
                
                fileInfo.style.display = 'block';
            } else {
                fileInfo.style.display = 'none';
            }
        }
        
        // åŠ è½½è´¦å·åˆ—è¡¨åˆ°å¤é€‰æ¡†
        function loadVideoAccountList() {
            fetch(`${API_BASE}/accounts`)
                .then(r => r.json())
                .then(res => {
                    if (res.code === 200) {
                        const accounts = res.data.filter(a => a.login_status === 'logged_in' && a.cookies);
                        const accountListDiv = document.getElementById('videoAccountList');
                        
                        if (accounts.length === 0) {
                            accountListDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æ²¡æœ‰å·²ç™»å½•çš„è´¦å·ï¼Œè¯·å…ˆç™»å½•è´¦å·</p>';
                            return;
                        }
                        
                        const html = accounts.map(a => `
                            <div style="padding: 8px 10px; border-bottom: 1px solid #eee; background: white; border-radius: 4px; margin-bottom: 4px;">
                                <label style="display: flex; align-items: center; cursor: pointer; margin: 0; width: 100%;">
                                    <input type="checkbox" value="${a.id}" class="video-account-checkbox" style="margin-right: 10px; flex-shrink: 0; width: 18px; height: 18px; cursor: pointer;" onchange="updateSelectedCount()">
                                    <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
                                        <span style="font-size: 14px; font-weight: 600; color: #333; margin-bottom: 2px;">${a.account_name || 'æœªå‘½åè´¦å·'}</span>
                                        <span style="font-size: 11px; color: #999;">è´¦å·ID: ${a.id}</span>
                                    </div>
                                    <span class="status-badge status-${a.login_status}" style="font-size: 10px; padding: 3px 8px; flex-shrink: 0; margin-left: 10px; white-space: nowrap;">å·²ç™»å½•</span>
                                </label>
                            </div>
                        `).join('');
                        accountListDiv.innerHTML = html;
                        updateSelectedCount();
                    }
                })
                .catch(e => {
                    console.error('Load accounts error:', e);
                    document.getElementById('videoAccountList').innerHTML = '<p style="color: #c00;">åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥</p>';
                });
        }
        
        // å…¨é€‰è´¦å·
        function selectAllAccounts() {
            const checkboxes = document.querySelectorAll('.video-account-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedCount();
        }
        
        // å–æ¶ˆå…¨é€‰è´¦å·
        function deselectAllAccounts() {
            const checkboxes = document.querySelectorAll('.video-account-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedCount();
        }
        
        // æ›´æ–°é€‰ä¸­è´¦å·æ•°é‡
        function updateSelectedCount() {
            const selectedCount = document.querySelectorAll('.video-account-checkbox:checked').length;
            const countElement = document.getElementById('selectedAccountCount');
            if (countElement) {
                countElement.textContent = selectedCount;
            }
        }
        
        // è·å–é€‰ä¸­çš„è´¦å·IDåˆ—è¡¨
        function getSelectedAccountIds() {
            const checkboxes = document.querySelectorAll('.video-account-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }
        
        // è§†é¢‘ä¸Šä¼ 
        function createVideoTask(event) {
            // å¦‚æœæ²¡æœ‰ä¼ å…¥eventï¼Œå°è¯•ä»æŒ‰é’®è·å–
            if (!event) {
                event = { target: document.getElementById('uploadVideoBtn') };
            }
            
            const selectedAccountIds = getSelectedAccountIds();
            const uploadType = document.getElementById('videoUploadType').value;
            const title = document.getElementById('videoTitle').value;
            const tags = document.getElementById('videoTags').value;
            
            if (selectedAccountIds.length === 0) {
                showMessage('videoMessage', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè´¦å·', 'error');
                return;
            }
            
            // å¦‚æœæ˜¯æ–‡ä»¶ä¸Šä¼ 
            if (uploadType === 'file') {
                const videoFile = document.getElementById('videoFile').files[0];
                if (!videoFile) {
                    showMessage('videoMessage', 'è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶', 'error');
                    return;
                }
                
                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦æç¤º
                const uploadBtn = event.target || document.getElementById('uploadVideoBtn');
                const originalText = uploadBtn.textContent;
                uploadBtn.disabled = true;
                uploadBtn.textContent = `ä¸Šä¼ ä¸­... (${selectedAccountIds.length}ä¸ªè´¦å·)`;
                
                showMessage('videoMessage', `æ­£åœ¨ä¸º ${selectedAccountIds.length} ä¸ªè´¦å·ä¸Šä¼ è§†é¢‘ï¼Œè¯·ç¨å€™...ï¼ˆå¤§æ–‡ä»¶å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰`, 'success');
                
                // ä¸ºæ¯ä¸ªè´¦å·ä¸Šä¼ è§†é¢‘
                let uploadCount = 0;
                let successCount = 0;
                let failCount = 0;
                
                // ä¸ºæ¯ä¸ªè´¦å·ä¸Šä¼ è§†é¢‘ï¼ˆcenteræ¥å£ä¼šè‡ªåŠ¨ä»æ•°æ®åº“è·å–è¯¥è´¦å·çš„cookiesï¼‰
                selectedAccountIds.forEach((accountId, index) => {
                    // å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…åŒæ—¶ä¸Šä¼ å¯¼è‡´æœåŠ¡å™¨å‹åŠ›è¿‡å¤§
                    setTimeout(() => {
                        // ä½¿ç”¨FormDataä¸Šä¼ æ–‡ä»¶ï¼ˆcenteræ¥å£ä¼šè‡ªåŠ¨ä»æ•°æ®åº“è·å–è¯¥è´¦å·çš„cookiesï¼‰
                        const formData = new FormData();
                        formData.append('video', videoFile);
                        formData.append('account_id', accountId);
                        if (title) formData.append('title', title);
                        if (tags) formData.append('tags', tags);
                        
                        fetch(`${API_BASE}/social/upload`, {
                            method: 'POST',
                            body: formData
                        })
                        .then(r => r.json())
                        .then(res => {
                            uploadCount++;
                            if (res && (res.code === 200 || res.code === 201)) {
                                successCount++;
                                // ç«‹å³åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                                loadVideoList();
                            } else {
                                failCount++;
                            }
                            checkUploadComplete();
                        })
                        .catch(e => {
                            console.error(`Upload error for account ${accountId}:`, e);
                            uploadCount++;
                            failCount++;
                            checkUploadComplete();
                        });
                    }, index * 500); // æ¯ä¸ªè¯·æ±‚å»¶è¿Ÿ500msï¼Œé¿å…åŒæ—¶ä¸Šä¼ 
                });
                
                function checkUploadComplete() {
                    if (uploadCount === selectedAccountIds.length) {
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = originalText;
                        
                        if (successCount > 0) {
                            showMessage('videoMessage', `ä¸Šä¼ ä»»åŠ¡å·²åˆ›å»ºï¼æˆåŠŸ: ${successCount} ä¸ªè´¦å·ï¼Œå¤±è´¥: ${failCount} ä¸ªè´¦å·ã€‚è¯·åˆ‡æ¢åˆ°"ä»»åŠ¡åˆ—è¡¨"æŸ¥çœ‹è¿›åº¦ã€‚`, successCount === selectedAccountIds.length ? 'success' : 'error');
                            // æ¸…ç©ºè¡¨å•
                            document.getElementById('videoFile').value = '';
                            document.getElementById('videoTitle').value = '';
                            document.getElementById('videoTags').value = '';
                            document.getElementById('videoFileInfo').style.display = 'none';
                            // å–æ¶ˆæ‰€æœ‰é€‰æ‹©
                            deselectAllAccounts();
                            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                            loadVideoList();
                            // å¦‚æœä»»åŠ¡åˆ—è¡¨æ ‡ç­¾é¡µæ˜¯æ¿€æ´»çš„ï¼Œå¯åŠ¨è‡ªåŠ¨åˆ·æ–°
                            if (document.getElementById('videoList').classList.contains('active')) {
                                startVideoListAutoRefresh();
                            }
                        } else {
                            showMessage('videoMessage', `æ‰€æœ‰è´¦å·ä¸Šä¼ å¤±è´¥`, 'error');
                        }
                    }
                }
            } else {
                // ä½¿ç”¨URLæ–¹å¼ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼Œä½†åªæ”¯æŒå•ä¸ªè´¦å·ï¼‰
                if (selectedAccountIds.length > 1) {
                    showMessage('videoMessage', 'URLæ–¹å¼æš‚ä¸æ”¯æŒå¤šè´¦å·ï¼Œè¯·åªé€‰æ‹©ä¸€ä¸ªè´¦å·', 'error');
                    return;
                }
                
                const videoUrl = document.getElementById('videoUrl').value;
                if (!videoUrl) {
                    showMessage('videoMessage', 'è¯·è¾“å…¥è§†é¢‘URL', 'error');
                    return;
                }
                
                const accountId = selectedAccountIds[0];
                const data = {
                    account_id: accountId,
                    video_url: videoUrl,
                    video_title: title,
                    video_tags: tags ? tags.split(',').map(t => t.trim()) : null
                };
                
                fetch(`${API_BASE}/video/upload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(r => r.json())
                .then(res => {
                    if (res.code === 201) {
                        showMessage('videoMessage', 'è§†é¢‘ä»»åŠ¡å·²åˆ›å»º', 'success');
                        document.getElementById('videoDeviceId').value = '';
                        document.getElementById('videoUrl').value = '';
                        document.getElementById('videoTitle').value = '';
                        document.getElementById('videoTags').value = '';
                        deselectAllAccounts();
                        loadVideoList();
                    } else {
                        showMessage('videoMessage', res.message, 'error');
                    }
                })
                .catch(e => showMessage('videoMessage', 'è¯·æ±‚å¤±è´¥: ' + e.message, 'error'));
            }
        }
        
        function loadVideoList() {
            fetch(`${API_BASE}/video/tasks`)
                .then(r => r.json())
                .then(res => {
                    if (res.code === 200) {
                        const tasks = res.data || [];
                        
                        // çŠ¶æ€æ˜ å°„
                        const statusMap = {
                            'pending': { text: 'ç­‰å¾…ä¸­', class: 'pending' },
                            'uploading': { text: 'ä¸Šä¼ ä¸­', class: 'pending' },
                            'completed': { text: 'å·²å®Œæˆ', class: 'success' },
                            'failed': { text: 'å¤±è´¥', class: 'failed' }
                        };
                        
                        const html = tasks.length ? `
                            <div style="margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>å…± ${tasks.length} ä¸ªä»»åŠ¡</strong>
                                    </div>
                                    <div style="font-size: 12px; opacity: 0.9;">
                                        å·²å®Œæˆ: ${tasks.filter(t => t.status === 'completed').length} | 
                                        è¿›è¡Œä¸­: ${tasks.filter(t => t.status === 'uploading' || t.status === 'pending').length} | 
                                        å¤±è´¥: ${tasks.filter(t => t.status === 'failed').length}
                                    </div>
                                </div>
                            </div>
                            <table>
                                <tr>
                                    <th>ID</th>
                                    <th>è´¦å·ID</th>
                                    <th>è§†é¢‘æ ‡é¢˜</th>
                                    <th>çŠ¶æ€</th>
                                    <th>è¿›åº¦</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>å®Œæˆæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                                ${tasks.map(t => {
                                    const statusInfo = statusMap[t.status] || { text: t.status, class: 'pending' };
                                    // è½¬ä¹‰è§†é¢‘æ ‡é¢˜ä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢XSS
                                    const videoTitleEscaped = (t.video_title || '-').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                    return `
                                        <tr>
                                            <td>${t.id}</td>
                                            <td>${t.account_id}</td>
                                            <td>${t.video_title || '-'}</td>
                                            <td><span class="status-badge status-${statusInfo.class}">${statusInfo.text}</span></td>
                                            <td>${t.progress || 0}%</td>
                                            <td>${t.created_at ? new Date(t.created_at).toLocaleString('zh-CN') : '-'}</td>
                                            <td>${t.completed_at ? new Date(t.completed_at).toLocaleString('zh-CN') : '-'}</td>
                                            <td>
                                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px; background: #f8d7da; color: #721c24;" onclick="deleteVideoTask(${t.id}, '${videoTitleEscaped}', '${statusInfo.text}')">
                                                    åˆ é™¤
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </table>
                        ` : '<div style="text-align: center; padding: 40px; color: #999;"><p>æš‚æ— ä»»åŠ¡</p><small>ä¸Šä¼ è§†é¢‘åï¼Œä»»åŠ¡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</small></div>';
                        document.getElementById('videoListContent').innerHTML = html;
                    } else {
                        document.getElementById('videoListContent').innerHTML = '<p style="color: #c00; text-align: center; padding: 20px;">åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥</p>';
                    }
                })
                .catch(e => {
                    console.error('Load video tasks error:', e);
                    document.getElementById('videoListContent').innerHTML = '<p style="color: #c00; text-align: center; padding: 20px;">åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥: ' + e.message + '</p>';
                });
        }
        
        // åˆ é™¤è§†é¢‘ä»»åŠ¡
        function deleteVideoTask(taskId, videoTitle, statusText) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è§†é¢‘ä»»åŠ¡å—ï¼Ÿ\n\nä»»åŠ¡ID: ${taskId}\nè§†é¢‘æ ‡é¢˜: ${videoTitle}\nçŠ¶æ€: ${statusText}\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            fetch(`${API_BASE}/video/tasks/${taskId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(r => r.json())
            .then(res => {
                if (res.code === 200) {
                    showMessage('videoMessage', `ä»»åŠ¡ ${taskId} å·²æˆåŠŸåˆ é™¤`, 'success');
                    // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                    loadVideoList();
                } else {
                    showMessage('videoMessage', res.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            })
            .catch(e => {
                showMessage('videoMessage', 'åˆ é™¤å¤±è´¥: ' + e.message, 'error');
            });
        }
        
        // æ¶ˆæ¯ç®¡ç†åŠŸèƒ½
        let listeningAccounts = {}; // å­˜å‚¨æ­£åœ¨ç›‘å¬çš„è´¦å·çŠ¶æ€
        let messageRefreshInterval = null;
        
        // åŠ è½½ç›‘å¬ä»»åŠ¡åˆ—è¡¨
        function loadListenTasks() {
            const accountId = document.getElementById('listenAccountId').value;
            const tasksListDiv = document.getElementById('listenTasksList');
            
            if (!accountId) {
                tasksListDiv.innerHTML = '<p style="color: #999; text-align: center; margin: 20px 0;">è¯·é€‰æ‹©è´¦å·æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨</p>';
                return;
            }
            
            tasksListDiv.innerHTML = '<div class="loading" style="margin: 20px auto;"></div><p style="text-align: center; color: #666;">æ­£åœ¨åŠ è½½ä»»åŠ¡åˆ—è¡¨...</p>';
            
            fetch(`${API_BASE}/listen/tasks?account_id=${accountId}`)
                .then(r => r.json())
                .then(res => {
                    if (res.code === 200 && res.data && Array.isArray(res.data)) {
                        const tasks = res.data;
                        
                        if (tasks.length === 0) {
                            tasksListDiv.innerHTML = '<p style="color: #999; text-align: center; margin: 20px 0;">è¯¥è´¦å·æš‚æ— ç›‘å¬ä»»åŠ¡</p>';
                            return;
                        }
                        
                        // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åº
                        tasks.sort((a, b) => {
                            const timeA = a.created_at ? new Date(a.created_at).getTime() : 0;
                            const timeB = b.created_at ? new Date(b.created_at).getTime() : 0;
                            return timeB - timeA;
                        });
                        
                        const html = `
                            <div style="font-size: 12px;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f5f5f5;">
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">ID</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">æ“ä½œ</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">çŠ¶æ€</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">åˆ›å»ºæ—¶é—´</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">å¼€å§‹æ—¶é—´</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">å®Œæˆæ—¶é—´</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">é”™è¯¯ä¿¡æ¯</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tasks.map(task => {
                                            const statusClass = task.status === 'running' ? 'status-success' : 
                                                              task.status === 'stopped' ? 'status-offline' : 
                                                              task.status === 'failed' ? 'status-failed' : 'status-pending';
                                            const statusText = task.status === 'running' ? 'è¿è¡Œä¸­' : 
                                                              task.status === 'stopped' ? 'å·²åœæ­¢' : 
                                                              task.status === 'failed' ? 'å¤±è´¥' : 
                                                              task.status === 'pending' ? 'ç­‰å¾…ä¸­' : task.status;
                                            const actionText = task.action === 'start' ? 'å¼€å§‹ç›‘å¬' : 
                                                              task.action === 'stop' ? 'åœæ­¢ç›‘å¬' : task.action;
                                            
                                            const formatTime = (timeStr) => {
                                                if (!timeStr) return '-';
                                                try {
                                                    return new Date(timeStr).toLocaleString('zh-CN', {hour12: false});
                                                } catch(e) {
                                                    return timeStr;
                                                }
                                            };
                                            
                                            // é«˜äº®æ˜¾ç¤ºrunningçŠ¶æ€çš„startä»»åŠ¡
                                            const rowStyle = (task.action === 'start' && task.status === 'running') ? 
                                                'background: #e8f5e9; border-left: 3px solid #4caf50;' : '';
                                            
                                            return `
                                                <tr style="border-bottom: 1px solid #eee; ${rowStyle}">
                                                    <td style="padding: 8px;">${task.id}</td>
                                                    <td style="padding: 8px;"><strong>${actionText}</strong></td>
                                                    <td style="padding: 8px;">
                                                        <span class="status-badge ${statusClass}">${statusText}</span>
                                                    </td>
                                                    <td style="padding: 8px; color: #666;">${formatTime(task.created_at)}</td>
                                                    <td style="padding: 8px; color: #666;">${formatTime(task.started_at)}</td>
                                                    <td style="padding: 8px; color: #666;">${formatTime(task.completed_at)}</td>
                                                    <td style="padding: 8px; color: #c00; font-size: 11px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${task.error_message || ''}">
                                                        ${task.error_message || '-'}
                                                    </td>
                                                    <td style="padding: 8px;">
                                                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px; background: #f8d7da; color: #721c24;" onclick="deleteListenTask(${task.id}, '${actionText}', '${statusText}')">
                                                            åˆ é™¤
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        tasksListDiv.innerHTML = html;
                    } else {
                        tasksListDiv.innerHTML = '<p style="color: #c00; text-align: center; margin: 20px 0;">åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥</p>';
                    }
                })
                .catch(e => {
                    console.error('Load listen tasks error:', e);
                    tasksListDiv.innerHTML = '<p style="color: #c00; text-align: center; margin: 20px 0;">åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥: ' + e.message + '</p>';
                });
        }
        
        // åˆ é™¤ç›‘å¬ä»»åŠ¡
        function deleteListenTask(taskId, actionText, statusText) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç›‘å¬ä»»åŠ¡å—ï¼Ÿ\n\nä»»åŠ¡ID: ${taskId}\næ“ä½œ: ${actionText}\nçŠ¶æ€: ${statusText}\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }
            
            fetch(`${API_BASE}/listen/tasks/${taskId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(r => r.json())
            .then(res => {
                if (res.code === 200) {
                    showMessage('messageStatusMessage', `ä»»åŠ¡ ${taskId} å·²æˆåŠŸåˆ é™¤`, 'success');
                    // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                    loadListenTasks();
                    // åˆ·æ–°ç›‘å¬çŠ¶æ€
                    loadListenStatus();
                } else {
                    showMessage('messageStatusMessage', res.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            })
            .catch(e => {
                showMessage('messageStatusMessage', 'åˆ é™¤å¤±è´¥: ' + e.message, 'error');
            });
        }
        
        // åŠ è½½è´¦å·é€‰é¡¹åˆ°ä¸‹æ‹‰æ¡†
        function loadAccountOptions() {
            fetch(`${API_BASE}/accounts`)
                .then(r => r.json())
                .then(res => {
                    if (res.code === 200) {
                        const accounts = res.data.filter(a => a.login_status === 'logged_in' && a.cookies);
                        const options = accounts.map(a => 
                            `<option value="${a.id}">${a.account_name} (ID: ${a.id})</option>`
                        ).join('');
                        
                        // æ›´æ–°æ‰€æœ‰è´¦å·é€‰æ‹©ä¸‹æ‹‰æ¡†
                        document.getElementById('listenAccountId').innerHTML = '<option value="">è¯·é€‰æ‹©è´¦å·</option>' + options;
                        document.getElementById('viewAccountId').innerHTML = '<option value="">è¯·é€‰æ‹©è´¦å·</option>' + options;
                        document.getElementById('sendAccountId').innerHTML = '<option value="">è¯·é€‰æ‹©è´¦å·</option>' + options;
                    }
                })
                .catch(e => console.error('Load accounts error:', e));
        }
        
        // åŠ è½½ç›‘å¬çŠ¶æ€
        function loadListenStatus() {
            const accountId = document.getElementById('listenAccountId').value;
            const statusDiv = document.getElementById('listenStatus');
            const toggleBtn = document.getElementById('listenToggleBtn');
            
            if (!accountId) {
                statusDiv.innerHTML = '<p style="margin: 0; color: #666;">è¯·é€‰æ‹©è´¦å·å¼€å§‹ç›‘å¬</p>';
                toggleBtn.disabled = true;
                toggleBtn.textContent = 'å¼€å§‹ç›‘å¬';
                // æ¸…é™¤æ‰€æœ‰æœ¬åœ°çŠ¶æ€ï¼ˆå› ä¸ºæœªé€‰æ‹©è´¦å·ï¼‰
                listeningAccounts = {};
                // æ¸…ç©ºä»»åŠ¡åˆ—è¡¨
                document.getElementById('listenTasksList').innerHTML = '<p style="color: #999; text-align: center; margin: 20px 0;">è¯·é€‰æ‹©è´¦å·æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨</p>';
                return;
            }
            
            // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œé¿å…æ˜¾ç¤ºé”™è¯¯çš„çŠ¶æ€
            statusDiv.innerHTML = '<p style="margin: 0; color: #666;">æ­£åœ¨æŸ¥è¯¢çŠ¶æ€...</p>';
            toggleBtn.disabled = true;
            
            // åŒæ—¶æŸ¥è¯¢ç›‘å¬ä»»åŠ¡çŠ¶æ€å’Œæ¶ˆæ¯æ•°é‡
            // æ³¨æ„ï¼šæŸ¥è¯¢æ‰€æœ‰ä»»åŠ¡ï¼Œç„¶ååœ¨å‰ç«¯ä¸¥æ ¼è¿‡æ»¤ï¼Œç¡®ä¿åªæ˜¾ç¤ºçœŸæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
            Promise.all([
                fetch(`${API_BASE}/listen/tasks?account_id=${accountId}`).then(r => r.json()),
                fetch(`${API_BASE}/social/listen/messages?account_id=${accountId}&limit=1`).then(r => r.json())
            ])
                .then(([tasksRes, messagesRes]) => {
                    // åŠ è½½ä»»åŠ¡åˆ—è¡¨
                    loadListenTasks();
                    
                    // åˆ¤æ–­é€»è¾‘ï¼šä¾æ®æœ€è¿‘çš„ä¸€ä¸ªä»»åŠ¡æ¥åˆ¤æ–­ç›‘å¬çŠ¶æ€
                    // 1. æ‰¾åˆ°æœ€è¿‘çš„ä¸€ä¸ªä»»åŠ¡ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼‰
                    // 2. å¦‚æœæœ€è¿‘çš„ä»»åŠ¡æ˜¯ start ä¸” status='running'ï¼Œåˆ™è®¤ä¸ºæ­£åœ¨ç›‘å¬
                    // 3. å¦‚æœæœ€è¿‘çš„ä»»åŠ¡æ˜¯ start ä¸” status='pending'ï¼Œåˆ™è®¤ä¸ºæ­£åœ¨å¯åŠ¨ç›‘å¬
                    // 4. å¦‚æœæœ€è¿‘çš„ä»»åŠ¡æ˜¯ stop æˆ–è€…æ²¡æœ‰ start ä»»åŠ¡ï¼Œåˆ™è®¤ä¸ºæœªåœ¨ç›‘å¬
                    let isListening = false;
                    let isStarting = false; // æ˜¯å¦æ­£åœ¨å¯åŠ¨
                    if (tasksRes.code === 200 && tasksRes.data && Array.isArray(tasksRes.data) && tasksRes.data.length > 0) {
                        // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åºï¼Œè·å–æœ€è¿‘çš„ä»»åŠ¡
                        const sortedTasks = [...tasksRes.data].sort((a, b) => {
                            const timeA = a.created_at ? new Date(a.created_at).getTime() : 0;
                            const timeB = b.created_at ? new Date(b.created_at).getTime() : 0;
                            return timeB - timeA; // å€’åºï¼Œæœ€æ–°çš„åœ¨å‰
                        });
                        
                        const latestTask = sortedTasks[0];
                        
                        // å¦‚æœæœ€è¿‘çš„ä»»åŠ¡æ˜¯ start ä¸” status='running'ï¼Œè®¤ä¸ºæ­£åœ¨ç›‘å¬
                        if (latestTask.action === 'start' && latestTask.status === 'running') {
                            isListening = true;
                            listeningAccounts[accountId] = true;
                        } 
                        // å¦‚æœæœ€è¿‘çš„ä»»åŠ¡æ˜¯ start ä¸” status='pending'ï¼Œè®¤ä¸ºæ­£åœ¨å¯åŠ¨ç›‘å¬
                        else if (latestTask.action === 'start' && latestTask.status === 'pending') {
                            isStarting = true;
                            listeningAccounts[accountId] = true; // ä¹Ÿè®¾ç½®æœ¬åœ°çŠ¶æ€ï¼Œè¡¨ç¤ºæ­£åœ¨å¤„ç†
                        } 
                        // æœ€è¿‘çš„ä»»åŠ¡ä¸æ˜¯ start ä»»åŠ¡ï¼Œæˆ–è€… start ä»»åŠ¡ä¸æ˜¯ running/pendingï¼Œè®¤ä¸ºæœªåœ¨ç›‘å¬
                        else {
                            isListening = false;
                            isStarting = false;
                            delete listeningAccounts[accountId];
                        }
                    } else {
                        // å¦‚æœæŸ¥è¯¢å¤±è´¥æˆ–æ²¡æœ‰ä»»åŠ¡ï¼Œæ¸…é™¤æœ¬åœ°çŠ¶æ€
                        delete listeningAccounts[accountId];
                    }
                    
                    const total = (messagesRes.code === 200 && messagesRes.data) ? messagesRes.data.total || 0 : 0;
                    
                    if (isListening) {
                        // æ­£åœ¨ç›‘å¬ä¸­
                        statusDiv.innerHTML = `
                            <div style="padding: 12px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border-radius: 8px; color: white;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <div class="loading" style="width: 16px; height: 16px; border-width: 2px;"></div>
                                    <strong>æ­£åœ¨ç›‘å¬ä¸­</strong>
                                </div>
                                <small style="opacity: 0.9;">å·²æ”¶åˆ° ${total} æ¡æ¶ˆæ¯</small>
                            </div>
                        `;
                        toggleBtn.textContent = 'åœæ­¢ç›‘å¬';
                        toggleBtn.disabled = false;
                    } else if (isStarting) {
                        // æ­£åœ¨å¯åŠ¨ç›‘å¬
                        statusDiv.innerHTML = `
                            <div style="padding: 12px; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border-radius: 8px; color: white;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <div class="loading" style="width: 16px; height: 16px; border-width: 2px;"></div>
                                    <strong>æ­£åœ¨å¯åŠ¨ç›‘å¬...</strong>
                                </div>
                                <small style="opacity: 0.9;">ç­‰å¾…å®¢æˆ·ç«¯å¤„ç†ä»»åŠ¡</small>
                            </div>
                        `;
                        toggleBtn.textContent = 'åœæ­¢ç›‘å¬';
                        toggleBtn.disabled = false; // å…è®¸åœæ­¢ï¼Œä»¥é˜²éœ€è¦å–æ¶ˆ
                    } else {
                        // æœªå¼€å§‹ç›‘å¬
                        statusDiv.innerHTML = `
                            <div style="padding: 12px; background: #f5f5f5; border-radius: 8px;">
                                <p style="margin: 0; color: #666;">
                                    <strong>æœªå¼€å§‹ç›‘å¬</strong><br>
                                    <small style="color: #999;">å½“å‰æœ‰ ${total} æ¡å†å²æ¶ˆæ¯</small>
                                </p>
                            </div>
                        `;
                        toggleBtn.textContent = 'å¼€å§‹ç›‘å¬';
                        toggleBtn.disabled = false;
                    }
                })
                .catch(e => {
                    console.error('Load listen status error:', e);
                    // å‡ºé”™æ—¶æ¸…é™¤æœ¬åœ°çŠ¶æ€
                    delete listeningAccounts[accountId];
                    statusDiv.innerHTML = '<p style="margin: 0; color: #666;">æœªå¼€å§‹ç›‘å¬</p>';
                    toggleBtn.textContent = 'å¼€å§‹ç›‘å¬';
                    toggleBtn.disabled = false;
                });
        }
        
        // åˆ‡æ¢ç›‘å¬çŠ¶æ€
        function toggleListen() {
            const accountId = document.getElementById('listenAccountId').value;
            if (!accountId) {
                showMessage('messageStatusMessage', 'è¯·å…ˆé€‰æ‹©è´¦å·', 'error');
                return;
            }
            
            // ä»æœåŠ¡å™¨æŸ¥è¯¢å®é™…çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä¾èµ–æœ¬åœ°çŠ¶æ€
            const toggleBtn = document.getElementById('listenToggleBtn');
            const currentBtnText = toggleBtn.textContent;
            const isListening = currentBtnText === 'åœæ­¢ç›‘å¬';
            
            if (isListening) {
                // åœæ­¢ç›‘å¬
                fetch(`${API_BASE}/social/listen/stop`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account_id: parseInt(accountId) })
                })
                .then(r => r.json())
                .then(res => {
                    if (res.code === 200 || res.code === 201) {
                        // ç«‹å³æ¸…é™¤æœ¬åœ°çŠ¶æ€
                        delete listeningAccounts[accountId];
                        showMessage('messageStatusMessage', 'ç›‘å¬å·²åœæ­¢', 'success');
                        
                        // ç«‹å³æ›´æ–°ç•Œé¢çŠ¶æ€ï¼ˆä¸æ˜¾ç¤ºè½¬åœˆï¼‰
                        const statusDiv = document.getElementById('listenStatus');
                        const toggleBtn = document.getElementById('listenToggleBtn');
                        statusDiv.innerHTML = `
                            <div style="padding: 12px; background: #f5f5f5; border-radius: 8px;">
                                <p style="margin: 0; color: #666;">
                                    <strong>æœªå¼€å§‹ç›‘å¬</strong><br>
                                    <small style="color: #999;">ç›‘å¬å·²åœæ­¢</small>
                                </p>
                            </div>
                        `;
                        toggleBtn.textContent = 'å¼€å§‹ç›‘å¬';
                        toggleBtn.disabled = false;
                        
                        // æ¸…é™¤æ¶ˆæ¯åˆ·æ–°å®šæ—¶å™¨
                        if (messageRefreshInterval) {
                            clearInterval(messageRefreshInterval);
                            messageRefreshInterval = null;
                        }
                        
                        // å»¶è¿Ÿåˆ·æ–°ä¸€æ¬¡çŠ¶æ€ï¼Œç¡®ä¿ä»æœåŠ¡å™¨è·å–æœ€æ–°çŠ¶æ€ï¼ˆç»™å®¢æˆ·ç«¯æ—¶é—´æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼‰
                        setTimeout(() => {
                            loadListenStatus();
                        }, 2000);
                        
                        // å¦‚æœå½“å‰åœ¨æŸ¥çœ‹æ¶ˆæ¯æ ‡ç­¾é¡µï¼Œåˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
                        if (document.getElementById('messageView').classList.contains('active')) {
                            if (document.getElementById('viewAccountId').value === accountId) {
                                loadMessages();
                            }
                        }
                    } else {
                        showMessage('messageStatusMessage', res.message, 'error');
                    }
                })
                .catch(e => showMessage('messageStatusMessage', 'åœæ­¢ç›‘å¬å¤±è´¥: ' + e.message, 'error'));
            } else {
                // å¼€å§‹ç›‘å¬
                fetch(`${API_BASE}/social/listen/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account_id: parseInt(accountId) })
                })
                .then(r => r.json())
                .then(res => {
                    if (res.code === 200 || res.code === 201) {
                        // æ›´æ–°æœ¬åœ°çŠ¶æ€
                        listeningAccounts[accountId] = true;
                        if (res.code === 200 && res.data && res.data.status === 'running') {
                            showMessage('messageStatusMessage', 'ç›‘å¬å·²åœ¨è¿è¡Œä¸­', 'success');
                        } else {
                            showMessage('messageStatusMessage', 'ç›‘å¬ä»»åŠ¡å·²åˆ›å»ºï¼Œç­‰å¾…å®¢æˆ·ç«¯å¤„ç†...', 'success');
                        }
                        
                        // ç«‹å³åˆ·æ–°çŠ¶æ€
                        loadListenStatus();
                        
                        // å»¶è¿Ÿå†æ¬¡åˆ·æ–°çŠ¶æ€ï¼Œç­‰å¾…å®¢æˆ·ç«¯å¤„ç†ä»»åŠ¡å¹¶æ›´æ–°çŠ¶æ€
                        setTimeout(() => {
                            loadListenStatus();
                        }, 2000);
                        
                        // å†å»¶è¿Ÿä¸€æ¬¡ï¼Œç¡®ä¿çŠ¶æ€æ›´æ–°
                        setTimeout(() => {
                            loadListenStatus();
                        }, 5000);
                        
                        // å¦‚æœå½“å‰åœ¨æŸ¥çœ‹æ¶ˆæ¯æ ‡ç­¾é¡µï¼Œè‡ªåŠ¨åˆ·æ–°
                        if (document.getElementById('messageView').classList.contains('active')) {
                            if (document.getElementById('viewAccountId').value === accountId) {
                                startMessageRefresh(accountId);
                            }
                        }
                    } else {
                        showMessage('messageStatusMessage', res.message || 'å¯åŠ¨ç›‘å¬å¤±è´¥', 'error');
                        // åˆ·æ–°çŠ¶æ€ä»¥æ˜¾ç¤ºå®é™…çŠ¶æ€
                        loadListenStatus();
                    }
                })
                .catch(e => showMessage('messageStatusMessage', 'å¯åŠ¨ç›‘å¬å¤±è´¥: ' + e.message, 'error'));
            }
        }
        
        // åŠ è½½æ¶ˆæ¯åˆ—è¡¨
        function loadMessages() {
            const accountId = document.getElementById('viewAccountId').value;
            const messagesDiv = document.getElementById('messagesList');
            
            if (!accountId) {
                messagesDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">è¯·é€‰æ‹©è´¦å·æŸ¥çœ‹æ¶ˆæ¯</p>';
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            messagesDiv.innerHTML = '<div class="loading" style="margin: 20px auto;"></div><p style="text-align: center; color: #666;">æ­£åœ¨åŠ è½½æ¶ˆæ¯...</p>';
            
            fetch(`${API_BASE}/social/listen/messages?account_id=${accountId}&limit=200`)
                .then(r => r.json())
                .then(res => {
                    if (res.code === 200) {
                        const messages = res.data.messages || [];
                        const total = res.data.total || 0;
                        const count = res.data.count || 0;
                        
                        if (messages.length === 0) {
                            messagesDiv.innerHTML = `
                                <div style="text-align: center; padding: 40px; color: #999;">
                                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ’¬</div>
                                    <p style="margin: 10px 0;">æš‚æ— æ¶ˆæ¯</p>
                                    <small style="color: #ccc;">æç¤ºï¼šè¯·å…ˆå¯åŠ¨æ¶ˆæ¯ç›‘å¬ä»¥è·å–æ¶ˆæ¯</small>
                                </div>
                            `;
                            return;
                        }
                        
                        // æŒ‰ç”¨æˆ·åˆ†ç»„æ˜¾ç¤ºæ¶ˆæ¯
                        const grouped = {};
                        messages.forEach(msg => {
                            const user = msg.user_name;
                            if (!grouped[user]) {
                                grouped[user] = [];
                            }
                            grouped[user].push(msg);
                        });
                        
                        let html = `
                            <div style="margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>å…± ${total} æ¡æ¶ˆæ¯</strong>
                                        <small style="opacity: 0.9; margin-left: 10px;">æ¥è‡ª ${Object.keys(grouped).length} ä¸ªç”¨æˆ·</small>
                                    </div>
                                    <button onclick="clearMessages()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        æ¸…ç©ºæ¶ˆæ¯
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // æŒ‰æ—¶é—´æ’åºç”¨æˆ·ï¼ˆæœ€æ–°æ¶ˆæ¯çš„ç”¨æˆ·åœ¨å‰ï¼‰
                        const sortedUsers = Object.keys(grouped).sort((a, b) => {
                            const aLatest = grouped[a][0]?.timestamp || '';
                            const bLatest = grouped[b][0]?.timestamp || '';
                            return bLatest.localeCompare(aLatest);
                        });
                        
                        for (const user of sortedUsers) {
                            const userMessages = grouped[user];
                            // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                            userMessages.sort((a, b) => {
                                const timeA = a.timestamp || a.time || '';
                                const timeB = b.timestamp || b.time || '';
                                return timeB.localeCompare(timeA);
                            });
                            
                            // ç»Ÿè®¡è¯¥ç”¨æˆ·çš„æ¶ˆæ¯æ•°
                            const userMsgCount = userMessages.length;
                            const unreadCount = userMessages.filter(m => !m.is_me).length;
                            
                            html += `
                                <div style="margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                                ${user.charAt(0).toUpperCase()}
                                            </div>
                                            <div>
                                                <h4 style="margin: 0; color: #333; font-size: 16px; font-weight: 600;">${user}</h4>
                                                <small style="color: #999; font-size: 12px;">${userMsgCount} æ¡æ¶ˆæ¯ ${unreadCount > 0 ? `Â· ${unreadCount} æ¡æœªè¯»` : ''}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="max-height: 400px; overflow-y: auto;">
                                        ${userMessages.map(msg => {
                                            const msgTime = msg.time || (msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : '');
                                            return `
                                                <div style="margin: 10px 0; padding: 12px; background: ${msg.is_me ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f5f5f5'}; border-radius: 8px; ${msg.is_me ? 'margin-left: 20%;' : 'margin-right: 20%;'}">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                                        <span style="font-weight: 600; color: ${msg.is_me ? 'white' : '#333'}; font-size: 13px;">
                                                            ${msg.is_me ? 'æˆ‘' : user}
                                                        </span>
                                                        <span style="font-size: 11px; color: ${msg.is_me ? 'rgba(255,255,255,0.8)' : '#999'};">
                                                            ${msgTime}
                                                        </span>
                                                    </div>
                                                    <div style="color: ${msg.is_me ? 'white' : '#333'}; word-wrap: break-word; line-height: 1.5; font-size: 14px;">
                                                        ${msg.text}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        
                        messagesDiv.innerHTML = html;
                        
                        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        
                        // å¦‚æœæ­£åœ¨ç›‘å¬ï¼Œå¯åŠ¨è‡ªåŠ¨åˆ·æ–°
                        if (listeningAccounts[accountId]) {
                            startMessageRefresh(accountId);
                        }
                    } else {
                        messagesDiv.innerHTML = `<p style="color: #c00; text-align: center; padding: 20px;">åŠ è½½æ¶ˆæ¯å¤±è´¥: ${res.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    }
                })
                .catch(e => {
                    console.error('Load messages error:', e);
                    messagesDiv.innerHTML = `<p style="color: #c00; text-align: center; padding: 20px;">åŠ è½½æ¶ˆæ¯å¤±è´¥: ${e.message}</p>`;
                });
        }
        
        // å¯åŠ¨æ¶ˆæ¯è‡ªåŠ¨åˆ·æ–°
        function startMessageRefresh(accountId) {
            if (messageRefreshInterval) {
                clearInterval(messageRefreshInterval);
            }
            messageRefreshInterval = setInterval(() => {
                const currentAccountId = document.getElementById('viewAccountId').value;
                if (currentAccountId === accountId && listeningAccounts[accountId]) {
                    loadMessages();
                } else {
                    clearInterval(messageRefreshInterval);
                    messageRefreshInterval = null;
                }
            }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
        }
        
        // æ¸…ç©ºæ¶ˆæ¯
        function clearMessages() {
            const accountId = document.getElementById('viewAccountId').value;
            if (!accountId) {
                showMessage('messageStatusMessage', 'è¯·å…ˆé€‰æ‹©è´¦å·', 'error');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè¯¥è´¦å·çš„æ‰€æœ‰æ¶ˆæ¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                fetch(`${API_BASE}/messages/clear`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account_id: parseInt(accountId) })
                })
                .then(r => r.json())
                .then(res => {
                    if (res.code === 200) {
                        showMessage('messageStatusMessage', `å·²æ¸…ç©º ${res.data.deleted_count} æ¡æ¶ˆæ¯`, 'success');
                        loadMessages();
                    } else {
                        showMessage('messageStatusMessage', res.message, 'error');
                    }
                })
                .catch(e => showMessage('messageStatusMessage', 'æ¸…ç©ºå¤±è´¥: ' + e.message, 'error'));
            }
        }
        
        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const accountId = document.getElementById('sendAccountId').value;
            const targetUser = document.getElementById('sendTargetUser').value;
            const message = document.getElementById('sendMessageText').value;
            
            if (!accountId || !targetUser || !message) {
                showMessage('sendStatusMessage', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
                return;
            }
            
            showMessage('sendStatusMessage', 'æ­£åœ¨å‘é€æ¶ˆæ¯...', 'success');
            
            fetch(`${API_BASE}/social/chat/reply`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    account_id: parseInt(accountId),
                    target_user: targetUser,
                    message: message
                })
            })
            .then(r => r.json())
            .then(res => {
                if (res.code === 200 || res.code === 201) {
                    showMessage('sendStatusMessage', 'æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                    document.getElementById('sendTargetUser').value = '';
                    document.getElementById('sendMessageText').value = '';
                } else {
                    showMessage('sendStatusMessage', res.message, 'error');
                }
            })
            .catch(e => showMessage('sendStatusMessage', 'å‘é€å¤±è´¥: ' + e.message, 'error'));
        }
        
        // å·¥å…·å‡½æ•°
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                el.innerHTML = '';
            }, 3000);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>

</html>