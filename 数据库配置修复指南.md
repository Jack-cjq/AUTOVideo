# 数据库配置修复指南

## 问题诊断

你遇到的错误：
```
Can't connect to MySQL server on 'jqq99@localhost'
```

这个错误表明 `.env` 文件中的 `DB_USER` 配置有问题，可能包含了 `@` 符号。

## 快速修复

### 方法一：使用修复脚本（推荐）

```bash
cd /var/www/autovideo/AUTOVideo
chmod +x fix_db_config.sh
./fix_db_config.sh
```

### 方法二：手动修复

1. **检查 `.env` 文件**

```bash
cd /var/www/autovideo/AUTOVideo/center_code/backend
cat .env | grep DB_USER
```

2. **修复配置**

如果看到类似这样的配置：
```bash
DB_USER=jqq99@localhost  # ❌ 错误
```

应该改为：
```bash
DB_USER=jqq99  # ✅ 正确
```

或者如果使用 root 用户：
```bash
DB_USER=root  # ✅ 正确
```

3. **编辑 `.env` 文件**

```bash
vim .env
```

确保数据库配置部分如下：

```bash
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=autovideo
DB_USER=root              # 只写用户名，不要包含 @
DB_PASSWORD=your_password  # 你的 MySQL 密码
```

## 验证修复

修复后，测试数据库连接：

```bash
cd /var/www/autovideo/AUTOVideo/center_code/backend
source venv/bin/activate

# 加载环境变量
set -a
source .env
set +a

# 测试连接
python -c "
from config import get_db_config
import pymysql
config = get_db_config()
try:
    conn = pymysql.connect(
        host=config['host'],
        port=config['port'],
        user=config['user'],
        password=config['password']
    )
    print('✓ 数据库连接成功！')
    conn.close()
except Exception as e:
    print(f'❌ 连接失败: {e}')
"
```

## 重新初始化数据库

修复配置后，重新初始化：

```bash
cd /var/www/autovideo/AUTOVideo/center_code/backend
source venv/bin/activate

# 加载环境变量
set -a
source .env
set +a

# 初始化数据库
python init_database.py
python init_user.py
```

## 重启服务

修复并初始化完成后，重启服务：

```bash
sudo systemctl restart autovideo
sudo systemctl status autovideo
```

## 常见问题

### Q: 如何查看当前配置？

```bash
cd /var/www/autovideo/AUTOVideo/center_code/backend
cat .env | grep "^DB_"
```

### Q: MySQL 服务未启动？

```bash
# 检查 MySQL 状态
sudo systemctl status mysql

# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql
```

### Q: 忘记 MySQL root 密码？

```bash
# 重置 MySQL root 密码
sudo mysql
```

在 MySQL 中执行：
```sql
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'your_new_password';
FLUSH PRIVILEGES;
EXIT;
```

### Q: 创建新的数据库用户？

```bash
sudo mysql -u root -p
```

在 MySQL 中执行：
```sql
CREATE USER 'autovideo'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON autovideo.* TO 'autovideo'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

然后在 `.env` 文件中：
```bash
DB_USER=autovideo
DB_PASSWORD=your_password
```

## 正确的 .env 文件格式示例

```bash
# Flask 环境
FLASK_ENV=production
ENVIRONMENT=production

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=autovideo
DB_USER=root
DB_PASSWORD=your_strong_password_here

# Flask Secret Key
SECRET_KEY=your_secret_key_here

# CORS 配置
CORS_ORIGINS=http://localhost,http://127.0.0.1

# AI 配置
DEEPSEEK_API_KEY=your_deepseek_api_key
DEEPSEEK_BASE_URL=https://api.deepseek.com
DEEPSEEK_MODEL=deepseek-chat

# 百度 TTS 配置
BAIDU_APP_ID=your_baidu_app_id
BAIDU_API_KEY=your_baidu_api_key
BAIDU_SECRET_KEY=your_baidu_secret_key

# FFmpeg 路径
FFMPEG_PATH=/usr/bin/ffmpeg

# 服务端口
PORT=8080
```

## 注意事项

1. **DB_USER 只包含用户名**，不要包含 `@` 符号
2. **DB_PASSWORD 不要包含特殊字符**，如果必须使用，请用引号包裹
3. **确保 MySQL 服务正在运行**
4. **确保数据库用户有足够权限**

修复完成后，服务应该可以正常启动了！

