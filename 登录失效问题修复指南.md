# ç™»å½•å¤±æ•ˆé—®é¢˜ä¿®å¤æŒ‡å—

## é—®é¢˜æè¿°

åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²åï¼Œç™»å½•æˆåŠŸä½†è·³è½¬åˆ°å…¶ä»–é¡µé¢æ—¶ç™»å½•çŠ¶æ€å¤±æ•ˆã€‚

## æ ¹æœ¬åŸå› 

1. **SESSION_COOKIE_SECURE é…ç½®é”™è¯¯**ï¼šç”Ÿäº§ç¯å¢ƒå¯ç”¨äº† `SESSION_COOKIE_SECURE = True`ï¼Œè¿™è¦æ±‚ä½¿ç”¨ HTTPSã€‚å¦‚æœæœåŠ¡å™¨ä½¿ç”¨ HTTPï¼Œæµè§ˆå™¨ä¸ä¼šå‘é€ Cookieï¼Œå¯¼è‡´ç™»å½•å¤±æ•ˆã€‚

2. **CORS é…ç½®ä¸å®Œæ•´**ï¼šCORS çš„ `origins` å¯èƒ½æ²¡æœ‰åŒ…å«å®é™…çš„è®¿é—®åŸŸå/IPã€‚

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ›´æ–°ä»£ç ï¼ˆå·²å®Œæˆï¼‰

ä»£ç å·²ä¿®å¤ï¼Œç°åœ¨ä¼šæ ¹æ® `USE_HTTPS` ç¯å¢ƒå˜é‡å†³å®šæ˜¯å¦å¯ç”¨ `SESSION_COOKIE_SECURE`ã€‚

### 2. é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```bash
cd /var/www/autovideo/AUTOVideo/center_code/backend
vim .env
```

**å¦‚æœä½¿ç”¨ HTTPï¼ˆæœªé…ç½® SSLï¼‰**ï¼š
```bash
# Flask ç¯å¢ƒ
FLASK_ENV=production
ENVIRONMENT=production

# é‡è¦ï¼šHTTP ç¯å¢ƒä¸è¦å¯ç”¨ USE_HTTPS
USE_HTTPS=false

# CORS é…ç½®ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸è®¾ç½®åˆ™å…è®¸æ‰€æœ‰æ¥æºï¼‰
# CORS_ORIGINS=http://your_domain.com,http://your_ip
```

**å¦‚æœä½¿ç”¨ HTTPSï¼ˆå·²é…ç½® SSLï¼‰**ï¼š
```bash
# Flask ç¯å¢ƒ
FLASK_ENV=production
ENVIRONMENT=production

# å¯ç”¨ HTTPS
USE_HTTPS=true

# CORS é…ç½®
CORS_ORIGINS=https://your_domain.com,https://www.your_domain.com
```

### 3. é‡å¯æœåŠ¡

```bash
sudo systemctl restart autovideo
sudo systemctl status autovideo
```

### 4. éªŒè¯ä¿®å¤

1. **æ¸…é™¤æµè§ˆå™¨ Cookie**ï¼š
   - æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
   - Application/å­˜å‚¨ â†’ Cookies
   - åˆ é™¤æ‰€æœ‰ç›¸å…³ Cookie

2. **é‡æ–°ç™»å½•**ï¼š
   - è®¿é—®ç½‘ç«™
   - ç™»å½•
   - æ£€æŸ¥ Cookie æ˜¯å¦è®¾ç½®æˆåŠŸ

3. **æµ‹è¯•è·³è½¬**ï¼š
   - ç™»å½•åè·³è½¬åˆ°å…¶ä»–é¡µé¢
   - æ£€æŸ¥ç™»å½•çŠ¶æ€æ˜¯å¦ä¿æŒ

## è°ƒè¯•æ–¹æ³•

### æ£€æŸ¥ Cookie è®¾ç½®

åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­ï¼š

1. **Network æ ‡ç­¾é¡µ**ï¼š
   - ç™»å½•åæŸ¥çœ‹ `/api/auth/login` è¯·æ±‚
   - æŸ¥çœ‹ Response Headers ä¸­çš„ `Set-Cookie`
   - ç¡®è®¤ Cookie æ˜¯å¦åŒ…å« `Secure` æ ‡å¿—

2. **Application æ ‡ç­¾é¡µ**ï¼š
   - æŸ¥çœ‹ Cookies
   - ç¡®è®¤ `session` Cookie æ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥ Cookie çš„ `Secure`ã€`HttpOnly`ã€`SameSite` å±æ€§

### æ£€æŸ¥åç«¯æ—¥å¿—

```bash
sudo journalctl -u autovideo -f
```

æŸ¥çœ‹ç™»å½•è¯·æ±‚å’Œåç»­è¯·æ±‚çš„æ—¥å¿—ã€‚

### æ£€æŸ¥ CORS é…ç½®

åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹æ˜¯å¦æœ‰ CORS é”™è¯¯ï¼š

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
fetch('/api/auth/check', {
  credentials: 'include'
}).then(r => r.json()).then(console.log)
```

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆç™»å½•å Cookie æ²¡æœ‰è®¾ç½®ï¼Ÿ

A: å¯èƒ½çš„åŸå› ï¼š
1. `SESSION_COOKIE_SECURE = True` ä½†ä½¿ç”¨ HTTP
2. CORS é…ç½®ä¸å…è®¸å½“å‰åŸŸå
3. æµè§ˆå™¨é˜»æ­¢äº†ç¬¬ä¸‰æ–¹ Cookie

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿ `.env` ä¸­ `USE_HTTPS=false`ï¼ˆå¦‚æœä½¿ç”¨ HTTPï¼‰
- æ£€æŸ¥ CORS é…ç½®
- æ¸…é™¤æµè§ˆå™¨ Cookie åé‡è¯•

### Q: Cookie è®¾ç½®äº†ä½†è¯·æ±‚æ—¶æ²¡æœ‰å‘é€ï¼Ÿ

A: å¯èƒ½çš„åŸå› ï¼š
1. Cookie çš„ `Domain` æˆ– `Path` ä¸åŒ¹é…
2. `SameSite` è®¾ç½®è¿‡ä¸¥
3. æµè§ˆå™¨å®‰å…¨ç­–ç•¥é˜»æ­¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ Cookie çš„ `Domain` å’Œ `Path`
- ç¡®ä¿ `SameSite=Lax`ï¼ˆå·²é»˜è®¤è®¾ç½®ï¼‰
- æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰è­¦å‘Š

### Q: é€šè¿‡ Nginx ä»£ç†æ—¶ Cookie å¤±æ•ˆï¼Ÿ

A: ç¡®ä¿ Nginx é…ç½®æ­£ç¡®ï¼š

```nginx
location / {
    proxy_pass http://127.0.0.1:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;  # é‡è¦ï¼šä¼ é€’åè®®ä¿¡æ¯
    
    # Cookie ç›¸å…³
    proxy_cookie_path / /;
    proxy_cookie_domain off;
}
```

### Q: å¦‚ä½•å¼ºåˆ¶ä½¿ç”¨ HTTPSï¼Ÿ

A: å¦‚æœé…ç½®äº† SSL è¯ä¹¦ï¼š

1. **æ›´æ–° `.env`**ï¼š
```bash
USE_HTTPS=true
```

2. **é…ç½® Nginx é‡å®šå‘**ï¼š
```nginx
server {
    listen 80;
    server_name your_domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    server_name your_domain.com;
    # SSL é…ç½®...
}
```

3. **é‡å¯æœåŠ¡**ï¼š
```bash
sudo systemctl restart autovideo
sudo systemctl reload nginx
```

## éªŒè¯æ¸…å•

- [ ] `.env` æ–‡ä»¶ä¸­ `USE_HTTPS` è®¾ç½®æ­£ç¡®
- [ ] `CORS_ORIGINS` åŒ…å«å®é™…è®¿é—®åœ°å€ï¼ˆæˆ–è®¾ç½®ä¸º `*`ï¼‰
- [ ] æœåŠ¡å·²é‡å¯
- [ ] æµè§ˆå™¨ Cookie å·²æ¸…é™¤
- [ ] ç™»å½•å Cookie æ­£ç¡®è®¾ç½®
- [ ] è·³è½¬åç™»å½•çŠ¶æ€ä¿æŒ
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ—  CORS é”™è¯¯

ä¿®å¤å®Œæˆåï¼Œç™»å½•çŠ¶æ€åº”è¯¥å¯ä»¥æ­£å¸¸ä¿æŒäº†ï¼ğŸ‰

